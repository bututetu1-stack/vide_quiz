<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿ºé”ã®ã‚¤ãƒ³ãƒˆãƒ­ã‚¯ã‚¤ã‚ºï¼ - ãƒ­ãƒ“ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
    </style>
</head>

<body class="bg-indigo-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

    <div class="text-center mb-10">
        <h1 class="text-5xl md:text-7xl font-bold text-yellow-400 title-shadow mb-2">ä¿ºé”ã®<br>ã‚¤ãƒ³ãƒˆãƒ­ã‚¯ã‚¤ã‚ºï¼</h1>
        <p class="text-pink-300 font-bold tracking-widest">ONLINE V4</p>
    </div>

    <!-- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ›ï¼ˆå…±é€šï¼‰ -->
    <div class="w-full max-w-md mb-8">
        <div class="bg-indigo-800 p-6 rounded-2xl border-4 border-yellow-500 shadow-2xl">
            <label class="block text-sm text-gray-300 mb-2 text-center">ğŸ‘¤ ã‚ãªãŸã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
            <input type="text" id="nickname" placeholder="è¡¨ç¤ºåã‚’å…¥åŠ›"
                class="w-full p-4 rounded-lg bg-indigo-950 border-2 border-yellow-500 text-center text-2xl font-bold focus:outline-none focus:ring-2 focus:ring-yellow-400">
            <p class="text-xs text-gray-400 text-center mt-2">ã“ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¯çµ±è¨ˆã‚„ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ä½¿ç”¨ã•ã‚Œã¾ã™</p>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full max-w-4xl">

        <!-- Join Room -->
        <div class="bg-indigo-800 p-5 rounded-2xl border-4 border-blue-500 shadow-2xl flex flex-col items-center">
            <h2 class="text-xl font-bold mb-3 text-blue-300">ğŸ® éƒ¨å±‹ã«å‚åŠ </h2>
            <div class="w-full space-y-2">
                <div>
                    <label class="block text-xs text-gray-300 mb-1">åˆè¨€è‘‰ï¼ˆéå…¬é–‹éƒ¨å±‹ç”¨ï¼‰</label>
                    <input type="text" id="joinRoomId" placeholder="ä¾‹: ABC123"
                        class="w-full p-2 rounded-lg bg-indigo-950 border border-blue-500 text-center text-lg font-mono uppercase focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <button onclick="joinRoom()"
                    class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-xl font-bold text-lg shadow-lg transform active:scale-95 transition">
                    å‚åŠ ã™ã‚‹ ğŸš€
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-2">å…¬é–‹éƒ¨å±‹ã¯ä¸‹ã®ä¸€è¦§ã‹ã‚‰å‚åŠ </p>
        </div>

        <!-- Create Room -->
        <div class="bg-indigo-800 p-5 rounded-2xl border-4 border-pink-500 shadow-2xl flex flex-col items-center">
            <h2 class="text-xl font-bold mb-3 text-pink-300">ğŸ‘‘ éƒ¨å±‹ã‚’ä½œã‚‹</h2>
            <div class="w-full space-y-2">
                <div>
                    <label class="block text-xs text-gray-300 mb-1">éƒ¨å±‹å</label>
                    <input type="text" id="roomName" placeholder="æ¥½ã—ãã‚„ã‚ã†ï¼"
                        class="w-full p-2 rounded-lg bg-indigo-950 border border-pink-500 text-center text-sm focus:outline-none focus:ring-2 focus:ring-pink-400">
                </div>
                <div>
                    <label class="block text-xs text-gray-300 mb-1">å…¬é–‹è¨­å®š</label>
                    <select id="roomVisibility" onchange="toggleRoomIdField()"
                        class="w-full p-2 rounded-lg bg-indigo-950 border border-pink-500 text-sm">
                        <option value="private">ğŸ”’ éå…¬é–‹ï¼ˆåˆè¨€è‘‰ã§å‚åŠ ï¼‰</option>
                        <option value="public">ğŸŒ å…¬é–‹ï¼ˆèª°ã§ã‚‚å‚åŠ å¯ï¼‰</option>
                    </select>
                </div>
                <div id="roomIdField">
                    <label class="block text-xs text-gray-300 mb-1">åˆè¨€è‘‰ï¼ˆç©ºæ¬„ã§è‡ªå‹•ï¼‰</label>
                    <input type="text" id="customRoomId" placeholder="ä¾‹: SAIKYOU"
                        class="w-full p-2 rounded-lg bg-indigo-950 border border-pink-500 text-center text-sm font-mono uppercase focus:outline-none focus:ring-2 focus:ring-pink-400">
                </div>
                <button onclick="createRoom()"
                    class="w-full bg-pink-500 hover:bg-pink-600 py-3 rounded-xl font-bold text-lg shadow-lg transform active:scale-95 transition">
                    ä½œæˆã™ã‚‹ âœ¨
                </button>
            </div>
        </div>

        <!-- Solo Mode -->
        <div class="bg-indigo-800 p-5 rounded-2xl border-4 border-green-500 shadow-2xl flex flex-col items-center">
            <h2 class="text-xl font-bold mb-3 text-green-300">ğŸ¯ ã‚½ãƒ­ã§ç·´ç¿’</h2>
            <p class="text-xs text-gray-400 text-center mb-3">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ã¯åæ˜ ã•ã‚Œã¾ã›ã‚“</p>
            <button onclick="createSoloRoom()"
                class="w-full bg-green-600 hover:bg-green-700 py-3 rounded-xl font-bold text-lg shadow-lg transform active:scale-95 transition">
                ç·´ç¿’ã‚¹ã‚¿ãƒ¼ãƒˆ ğŸš€
            </button>
        </div>

    </div>

    <!-- Find Public Rooms -->
    <div class="mt-6 w-full max-w-4xl">
        <button onclick="togglePublicRooms()" id="publicRoomsToggle"
            class="w-full bg-indigo-800 hover:bg-indigo-700 py-3 rounded-xl font-bold text-lg border border-indigo-600">
            ğŸ” å…¬é–‹éƒ¨å±‹ã‚’æ¢ã™ â–¼
        </button>
        <div id="publicRoomsList"
            class="hidden mt-2 bg-indigo-900/80 rounded-xl p-4 border border-indigo-600 max-h-64 overflow-y-auto">
            <div id="publicRoomsContent" class="space-y-2">
                <p class="text-gray-400 text-center">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- Links -->
    <div class="mt-12 flex flex-wrap justify-center gap-4">
        <a href="playlist.html" class="flex items-center text-gray-300 hover:text-white transition">
            <span class="bg-gray-700 p-2 rounded-full mr-2">ğŸµ</span> ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆç®¡ç†
        </a>
        <button onclick="openStatsModal()"
            class="flex items-center text-gray-300 hover:text-white transition bg-transparent border-none cursor-pointer">
            <span class="bg-purple-700 p-2 rounded-full mr-2">ğŸ“Š</span> çµ±è¨ˆã‚’è¦‹ã‚‹
        </button>
    </div>

    <!-- Stats Modal -->
    <div id="statsModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-indigo-900 rounded-2xl border-4 border-purple-500 shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-purple-500">
                <h2 class="text-2xl font-bold text-purple-300">ğŸ“Š çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                <button onclick="closeStatsModal()" class="text-2xl hover:text-red-400">âœ–</button>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-purple-500">
                <button onclick="showStatsTab('user')" id="tabUser"
                    class="flex-1 py-3 text-center font-bold bg-purple-600 border-r border-purple-500">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼</button>
                <button onclick="showStatsTab('song')" id="tabSong"
                    class="flex-1 py-3 text-center font-bold hover:bg-purple-600/50 border-r border-purple-500">ğŸµ
                    æ›²çµ±è¨ˆ</button>
                <button onclick="showStatsTab('ranking')" id="tabRanking"
                    class="flex-1 py-3 text-center font-bold hover:bg-purple-600/50">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-4">
                <!-- User Stats Tab -->
                <div id="statsUser" class="stats-tab">
                    <!-- è‡ªåˆ†ã®çµ±è¨ˆ -->
                    <div class="mb-4">
                        <button onclick="loadMyStats()"
                            class="w-full bg-green-600 hover:bg-green-700 py-3 rounded-lg font-bold mb-3">
                            ğŸ‘¤ è‡ªåˆ†ã®çµ±è¨ˆã‚’è¦‹ã‚‹
                        </button>
                    </div>
                    <div id="myStatsResult" class="mb-4"></div>

                    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ -->
                    <div class="border-t border-purple-500 pt-4">
                        <label class="block text-sm text-gray-300 mb-1">ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§æ¤œç´¢ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰</label>
                        <div class="flex gap-2">
                            <input type="text" id="statsSearchUser" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å"
                                class="flex-1 p-2 rounded bg-indigo-950 border border-purple-500">
                            <button onclick="searchUserStats()"
                                class="bg-purple-600 hover:bg-purple-700 px-4 rounded font-bold">æ¤œç´¢</button>
                        </div>
                    </div>
                    <div id="userStatsResult" class="space-y-2 mt-3"></div>
                </div>

                <!-- Song Stats Tab -->
                <div id="statsSong" class="stats-tab hidden">
                    <div id="songStatsList" class="space-y-2">
                        <p class="text-gray-400 text-center">èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>

                <!-- Ranking Tab -->
                <div id="statsRanking" class="stats-tab hidden">
                    <h3 class="text-lg font-bold text-yellow-400 mb-3">ğŸ† é †ä½ãƒã‚¤ãƒ³ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                    <p class="text-xs text-gray-400 mb-2">ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚: 1ä½=10pt, 2ä½=5pt, 3ä½=2pt</p>
                    <div id="rankPointsRankingList" class="space-y-2 mb-6"></div>

                    <h3 class="text-lg font-bold text-green-400 mb-3">âœ… ç·åˆæ­£è§£æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                    <div id="correctRankingList" class="space-y-2 mb-6"></div>

                    <h3 class="text-lg font-bold text-blue-400 mb-3">ğŸ¯ ç´¯è¨ˆãƒã‚¤ãƒ³ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                    <p class="text-xs text-gray-400 mb-2">ã‚²ãƒ¼ãƒ ä¸­ã®æ­£è§£ã§ç²å¾—ã—ãŸãƒã‚¤ãƒ³ãƒˆ</p>
                    <div id="pointsRankingList" class="space-y-2 mb-6"></div>

                    <h3 class="text-lg font-bold text-pink-400 mb-3">âš¡ é«˜é€Ÿå›ç­”ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                    <div id="speedRankingList" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Init Check
        function init() {
            // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’localStorageã‹ã‚‰å¾©å…ƒ
            const savedNickname = localStorage.getItem('vibeQuizNickname');
            if (savedNickname) {
                document.getElementById('nickname').value = savedNickname;
            }

            // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¤‰æ›´æ™‚ã«localStorageã«ä¿å­˜
            document.getElementById('nickname').addEventListener('input', function () {
                localStorage.setItem('vibeQuizNickname', this.value.trim());
            });
        }
        init();

        // â˜… å…¬é–‹è¨­å®šå¤‰æ›´æ™‚ã«åˆè¨€è‘‰æ¬„ã‚’è¡¨ç¤º/éè¡¨ç¤º â˜…
        function toggleRoomIdField() {
            const visibility = document.getElementById('roomVisibility').value;
            const roomIdField = document.getElementById('roomIdField');
            if (visibility === 'public') {
                roomIdField.classList.add('hidden');
            } else {
                roomIdField.classList.remove('hidden');
            }
        }

        // å‚åŠ ç”¨é–¢æ•°ï¼ˆåˆè¨€è‘‰ = Room IDï¼‰
        function joinRoom() {
            const nickname = document.getElementById('nickname').value.trim();
            const roomId = document.getElementById('joinRoomId').value.trim().toUpperCase();

            if (!nickname) { alert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            if (!roomId) { alert("åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

            localStorage.setItem('vibeQuizNickname', nickname);
            window.location.href = `quiz.html?room=${roomId}&user=${encodeURIComponent(nickname)}`;
        }

        // éƒ¨å±‹ä½œæˆé–¢æ•°
        async function createRoom() {
            const nickname = document.getElementById('nickname').value.trim();
            const customId = document.getElementById('customRoomId').value.trim().toUpperCase();
            const roomName = document.getElementById('roomName').value.trim() || `${nickname}ã®éƒ¨å±‹`;
            const visibility = document.getElementById('roomVisibility').value;

            if (!nickname) { alert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

            try {
                if (!window.VibeQuiz) { alert("Firebaseèª­è¾¼ä¸­... æ•°ç§’å¾…ã£ã¦ã­"); return; }

                localStorage.setItem('vibeQuizNickname', nickname);

                // å…¬é–‹éƒ¨å±‹ã®å ´åˆã¯åˆè¨€è‘‰è‡ªå‹•ç”Ÿæˆã€éå…¬é–‹ã¯æŒ‡å®šorè‡ªå‹•
                const roomId = await window.VibeQuiz.createRoom(nickname, {
                    maxQuestions: 10,
                    playlistIds: ['global'],
                    handicapMode: false,
                    correctPoints: 1,
                    wrongPoints: 0,
                    playDuration: 30,
                    answerTime: 15,
                    soloMode: false,
                    roomName: roomName,
                    visibility: visibility
                }, (visibility === 'public') ? null : (customId || null));

                if (visibility === 'private') {
                    alert(`éå…¬é–‹éƒ¨å±‹ã‚’ä½œæˆã—ã¾ã—ãŸï¼\nåˆè¨€è‘‰: ${roomId}\nå‹é”ã«ã“ã®åˆè¨€è‘‰ã‚’ä¼ãˆã¦ãã ã•ã„`);
                } else {
                    alert(`å…¬é–‹éƒ¨å±‹ã‚’ä½œæˆã—ã¾ã—ãŸï¼\nèª°ã§ã‚‚å‚åŠ ã§ãã¾ã™`);
                }

                localStorage.setItem(`host_${roomId}`, 'true');

                window.location.href = `quiz.html?room=${roomId}&user=${encodeURIComponent(nickname)}`;
            } catch (e) {
                alert("ä½œæˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n" + e.message);
            }
        }

        // ã‚½ãƒ­ãƒ¢ãƒ¼ãƒ‰ä½œæˆé–¢æ•°
        async function createSoloRoom() {
            const nickname = document.getElementById('nickname').value.trim();

            if (!nickname) { alert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

            try {
                if (!window.VibeQuiz) { alert("Firebaseèª­è¾¼ä¸­... æ•°ç§’å¾…ã£ã¦ã­"); return; }

                localStorage.setItem('vibeQuizNickname', nickname);

                const roomId = await window.VibeQuiz.createRoom(nickname, {
                    maxQuestions: 10,
                    playlistIds: ['global'],
                    handicapMode: false,
                    correctPoints: 1,
                    wrongPoints: 0,
                    playDuration: 30,
                    answerTime: 15,
                    soloMode: true,
                    roomName: 'ã‚½ãƒ­ç·´ç¿’',
                    visibility: 'private',
                    password: null
                }, null);

                localStorage.setItem(`host_${roomId}`, 'true');

                window.location.href = `quiz.html?room=${roomId}&user=${encodeURIComponent(nickname)}`;
            } catch (e) {
                alert("ä½œæˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n" + e.message);
            }
        }

        // å…¬é–‹éƒ¨å±‹ä¸€è¦§ã®è¡¨ç¤ºåˆ‡æ›¿
        function togglePublicRooms() {
            const list = document.getElementById('publicRoomsList');
            list.classList.toggle('hidden');
            if (!list.classList.contains('hidden')) {
                loadPublicRooms();
            }
        }

        // å…¬é–‹éƒ¨å±‹ä¸€è¦§ã‚’ãƒ­ãƒ¼ãƒ‰
        async function loadPublicRooms() {
            const content = document.getElementById('publicRoomsContent');
            content.innerHTML = '<p class="text-gray-400 text-center">èª­ã¿è¾¼ã¿ä¸­...</p>';

            try {
                if (!window.VibeQuiz) { return; }
                const rooms = await window.VibeQuiz.getPublicRooms();

                if (rooms.length === 0) {
                    content.innerHTML = '<p class="text-gray-400 text-center">å…¬é–‹éƒ¨å±‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                content.innerHTML = rooms.map(r => {
                    const statusText = r.status === 'waiting' ? 'ğŸŸ¢ å¾…æ©Ÿä¸­' : (r.status === 'playing' || r.status === 'buzzed' ? 'ğŸ”´ å¯¾æˆ¦ä¸­' : 'âšª çµ‚äº†');
                    const userCount = r.userCount || 0;
                    return `
                    <div class="bg-indigo-800 p-3 rounded flex justify-between items-center">
                        <div>
                            <div class="font-bold text-white">${r.roomName}</div>
                            <div class="text-xs text-gray-400">${statusText} | ${userCount}äººå‚åŠ  | by ${r.hostName}</div>
                        </div>
                        <button onclick="joinPublicRoom('${r.roomId}')" 
                            class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm font-bold">
                            ${r.status === 'waiting' ? 'å‚åŠ ' : 'è¦³æˆ¦'}
                        </button>
                    </div>
                    `;
                }).join('');
            } catch (e) {
                content.innerHTML = '<p class="text-red-400 text-center">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
            }
        }

        // å…¬é–‹éƒ¨å±‹ã«å‚åŠ ï¼ˆåˆè¨€è‘‰ä¸è¦ï¼‰
        function joinPublicRoom(roomId) {
            const nickname = document.getElementById('nickname').value.trim();
            if (!nickname) { alert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

            localStorage.setItem('vibeQuizNickname', nickname);
            window.location.href = `quiz.html?room=${roomId}&user=${encodeURIComponent(nickname)}`;
        }

        // â˜…â˜…â˜… çµ±è¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ â˜…â˜…â˜…
        function openStatsModal() {
            document.getElementById('statsModal').classList.remove('hidden');
            showStatsTab('user');
        }

        function closeStatsModal() {
            document.getElementById('statsModal').classList.add('hidden');
        }

        function showStatsTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.stats-tab').forEach(el => el.classList.add('hidden'));
            // Remove active from all tab buttons
            document.querySelectorAll('[id^="tab"]').forEach(el => {
                el.classList.remove('bg-purple-600');
                el.classList.add('hover:bg-purple-600/50');
            });

            // Show selected tab
            if (tab === 'user') {
                document.getElementById('statsUser').classList.remove('hidden');
                document.getElementById('tabUser').classList.add('bg-purple-600');
            } else if (tab === 'song') {
                document.getElementById('statsSong').classList.remove('hidden');
                document.getElementById('tabSong').classList.add('bg-purple-600');
                loadSongStats();
            } else if (tab === 'ranking') {
                document.getElementById('statsRanking').classList.remove('hidden');
                document.getElementById('tabRanking').classList.add('bg-purple-600');
                loadRankings();
            }
        }

        // è‡ªåˆ†ã®çµ±è¨ˆã‚’è¡¨ç¤º
        async function loadMyStats() {
            const result = document.getElementById('myStatsResult');
            result.innerHTML = '<p class="text-gray-400">èª­ã¿è¾¼ã¿ä¸­...</p>';

            try {
                const stats = await window.VibeQuiz.getMyStats();
                if (!stats) {
                    result.innerHTML = '<p class="text-gray-400">ã¾ã ãƒ—ãƒ¬ã‚¤è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚²ãƒ¼ãƒ ã‚’ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã¨çµ±è¨ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼</p>';
                    return;
                }

                result.innerHTML = renderUserStats(stats.displayName || 'è‡ªåˆ†', stats);
            } catch (e) {
                result.innerHTML = '<p class="text-red-400">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
            }
        }

        async function searchUserStats() {
            const name = document.getElementById('statsSearchUser').value.trim();
            if (!name) return;

            const result = document.getElementById('userStatsResult');
            result.innerHTML = '<p class="text-gray-400">æ¤œç´¢ä¸­...</p>';

            try {
                const users = await window.VibeQuiz.searchUserStats(name);
                if (users.length === 0) {
                    result.innerHTML = '<p class="text-gray-400">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
                    return;
                }

                result.innerHTML = users.map(u => renderUserStats(u.name, u)).join('');
            } catch (e) {
                result.innerHTML = '<p class="text-red-400">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
            }
        }

        function renderUserStats(name, stats) {
            const accuracy = (stats.totalCorrect || 0) + (stats.totalWrong || 0) > 0
                ? Math.round((stats.totalCorrect || 0) / ((stats.totalCorrect || 0) + (stats.totalWrong || 0)) * 100)
                : 0;

            let fastList = '';
            if (stats.fastAnswers && stats.fastAnswers.length > 0) {
                fastList = stats.fastAnswers.map((fa, i) =>
                    `<div class="text-sm flex justify-between"><span class="truncate">${i + 1}. ${fa.songTitle}</span><span
                class="text-yellow-400">${fa.time.toFixed(2)}ç§’</span></div>`
                ).join('');
            }

            return `
        <div class="bg-indigo-800 p-4 rounded-lg border border-purple-500 mb-2">
            <h3 class="text-xl font-bold text-white mb-3">ğŸ‘¤ ${name}</h3>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div class="bg-indigo-950 p-2 rounded">
                    <div class="text-gray-400">æ­£è§£æ•°</div>
                    <div class="text-xl font-bold text-green-400">${stats.totalCorrect || 0}</div>
                </div>
                <div class="bg-indigo-950 p-2 rounded">
                    <div class="text-gray-400">ä¸æ­£è§£æ•°</div>
                    <div class="text-xl font-bold text-red-400">${stats.totalWrong || 0}</div>
                </div>
                <div class="bg-indigo-950 p-2 rounded">
                    <div class="text-gray-400">æ­£ç­”ç‡</div>
                    <div class="text-xl font-bold text-blue-400">${accuracy}%</div>
                </div>
                <div class="bg-indigo-950 p-2 rounded">
                    <div class="text-gray-400">ç´¯è¨ˆãƒã‚¤ãƒ³ãƒˆ</div>
                    <div class="text-xl font-bold text-yellow-400">${stats.totalPoints || 0}pt</div>
                </div>
            </div>
            ${stats.fastestAnswer ? `<div class="mt-3 text-sm">âš¡ æœ€é€Ÿå›ç­”: <span
                    class="text-yellow-400 font-bold">${stats.fastestAnswer.toFixed(2)}ç§’</span></div>` : ''}
            ${fastList ? `<div class="mt-3">
                <div class="text-sm text-gray-400 mb-1">ğŸ† é«˜é€Ÿå›ç­”Top5:</div>${fastList}
            </div>` : ''}
        </div>
        `;
        }

        async function loadSongStats() {
            const list = document.getElementById('songStatsList');
            list.innerHTML = '<p class="text-gray-400 text-center">èª­ã¿è¾¼ã¿ä¸­...</p>';

            try {
                const songs = await window.VibeQuiz.getSongStats();
                if (songs.length === 0) {
                    list.innerHTML = '<p class="text-gray-400 text-center">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                // Sort by times played
                songs.sort((a, b) => (b.timesPlayed || 0) - (a.timesPlayed || 0));

                list.innerHTML = songs.slice(0, 20).map(s => `
        <div class="bg-indigo-800 p-3 rounded flex justify-between items-center text-sm">
            <div class="truncate flex-1 mr-2">
                <div class="font-bold">${s.titleMain || '???'}</div>
                <div class="text-xs text-gray-400">
                    å‡ºé¡Œ${s.timesPlayed || 0}å› | æ­£è§£ç‡${s.correctRate}%
                    ${s.averageAnswerTime ? ` | å¹³å‡${s.averageAnswerTime.toFixed(2)}ç§’` : ''}
                </div>
            </div>
            ${s.fastestAnswer ? `<div class="text-xs text-right">
                <div class="text-yellow-400">âš¡ ${s.fastestAnswer.time.toFixed(2)}ç§’</div>
                <div class="text-gray-400">${s.fastestAnswer.user}</div>
            </div>` : ''}
        </div>
        `).join('');
            } catch (e) {
                list.innerHTML = '<p class="text-red-400 text-center">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
            }
        }

        async function loadRankings() {
            const rankPointsList = document.getElementById('rankPointsRankingList');
            const correctList = document.getElementById('correctRankingList');
            const pointsList = document.getElementById('pointsRankingList');
            const speedList = document.getElementById('speedRankingList');

            try {
                const users = await window.VibeQuiz.getAllUserStats();

                // â˜… ä»Šé€±ã®é–‹å§‹æ—¥ã‚’è¨ˆç®—ï¼ˆæœˆæ›œ0æ™‚ï¼‰â˜…
                const now = new Date();
                const dayOfWeek = now.getDay();
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                weekStart.setHours(0, 0, 0, 0);
                const weekStartTime = weekStart.getTime();

                // é †ä½ãƒã‚¤ãƒ³ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆâ˜…ä»Šé€±åˆ†ã®ã¿è¡¨ç¤ºâ˜…ï¼‰
                const rankPointsSorted = [...users]
                    .filter(u => (u.weekStart || 0) >= weekStartTime && (u.weeklyRankPoints || 0) > 0)
                    .sort((a, b) => (b.weeklyRankPoints || 0) - (a.weeklyRankPoints || 0));
                rankPointsList.innerHTML = rankPointsSorted.slice(0, 5).map((u, i) => {
                    const medal = i === 0 ? 'ğŸ¥‡' : (i === 1 ? 'ğŸ¥ˆ' : (i === 2 ? 'ğŸ¥‰' : `${i + 1}.`));
                    return `
        <div class="bg-indigo-800 p-2 rounded flex justify-between items-center">
            <span><span class="text-lg mr-2">${medal}</span> ${u.name}</span>
            <span class="text-yellow-400 font-bold">${u.weeklyRankPoints || 0}pt</span>
        </div>
        `;
                }).join('') || '<p class="text-gray-400 text-center">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';

                // æ­£è§£æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                const correctSorted = [...users].sort((a, b) => (b.totalCorrect || 0) - (a.totalCorrect || 0));
                correctList.innerHTML = correctSorted.slice(0, 5).map((u, i) => {
                    const medal = i === 0 ? 'ğŸ¥‡' : (i === 1 ? 'ğŸ¥ˆ' : (i === 2 ? 'ğŸ¥‰' : `${i + 1}.`));
                    return `
        <div class="bg-indigo-800 p-2 rounded flex justify-between items-center">
            <span><span class="text-lg mr-2">${medal}</span> ${u.name}</span>
            <span class="text-green-400 font-bold">${u.totalCorrect || 0}å›</span>
        </div>
        `;
                }).join('') || '<p class="text-gray-400 text-center">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';

                // ç´¯è¨ˆãƒã‚¤ãƒ³ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°
                users.sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));
                pointsList.innerHTML = users.slice(0, 5).map((u, i) => {
                    const medal = i === 0 ? 'ğŸ¥‡' : (i === 1 ? 'ğŸ¥ˆ' : (i === 2 ? 'ğŸ¥‰' : `${i + 1}.`));
                    return `
        <div class="bg-indigo-800 p-2 rounded flex justify-between items-center">
            <span><span class="text-lg mr-2">${medal}</span> ${u.name}</span>
            <span class="text-blue-400 font-bold">${u.totalPoints || 0}pt</span>
        </div>
        `;
                }).join('') || '<p class="text-gray-400 text-center">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';

                // Speed Ranking
                const speedRanking = await window.VibeQuiz.getSpeedRanking();
                speedList.innerHTML = speedRanking.map((s, i) => {
                    const medal = i === 0 ? 'ğŸ¥‡' : (i === 1 ? 'ğŸ¥ˆ' : (i === 2 ? 'ğŸ¥‰' : `${i + 1}.`));
                    return `
        <div class="bg-indigo-800 p-2 rounded flex justify-between items-center text-sm">
            <span><span class="text-lg mr-2">${medal}</span> ${s.user}</span>
            <span class="truncate mx-2 text-gray-400">${s.songTitle}</span>
            <span class="text-yellow-400 font-bold">${s.time.toFixed(2)}ç§’</span>
        </div>
        `;
                }).join('') || '<p class="text-gray-400 text-center">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            } catch (e) {
                pointsList.innerHTML = '<p class="text-red-400 text-center">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
            }
        }

    </script>
    <!-- joinRoom script removed - using HTML form submission instead -->
</body>

</html>