<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿ºé”ã®ã‚¤ãƒ³ãƒˆãƒ­ã‚¯ã‚¤ã‚ºï¼ - ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1b4b;
        }

        ::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 4px;
        }
    </style>
</head>

<body class="bg-indigo-900 text-white min-h-screen flex flex-col">

    <header class="bg-indigo-800 p-4 border-b border-indigo-600 flex justify-between items-center z-10">
        <h1 class="font-bold text-xl text-yellow-400 flex items-center">
            <span class="text-2xl mr-2">ğŸµ</span> ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆç®¡ç†
        </h1>
        <a href="index.html" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-sm font-bold">ğŸ  ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</a>
    </header>

    <div class="flex-grow flex overflow-hidden">

        <!-- Sidebar: Playlist Selector -->
        <div class="w-64 bg-indigo-950 flex flex-col border-r border-indigo-800">
            <div class="p-4 border-b border-indigo-800 space-y-2">
                <button onclick="createPlaylist()"
                    class="w-full bg-pink-600 hover:bg-pink-700 text-white py-2 rounded font-bold shadow text-sm">
                    ï¼‹ æ–°è¦ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ
                </button>
                <button onclick="createPrivatePlaylist()"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded font-bold shadow text-sm">
                    ğŸ”’ å€‹äººç”¨ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ
                </button>
            </div>
            <div class="flex-grow overflow-y-auto p-2 space-y-2">
                <div onclick="selectPlaylist('global', 'Global (Default)')" id="pl-global"
                    class="p-3 rounded cursor-pointer transition hover:bg-indigo-800 bg-indigo-700 border-l-4 border-yellow-400">
                    <div class="font-bold text-sm">Global (Default)</div>
                    <div class="text-[10px] text-gray-400">æ¨™æº–ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</div>
                </div>
                <div id="playlistList" class="space-y-2"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-grow flex flex-col md:flex-row overflow-hidden bg-gray-900">

            <!-- Add Song Form -->
            <div class="w-full md:w-1/3 p-6 bg-gray-800 overflow-y-auto border-r border-gray-700">
                <h2 class="text-lg font-bold mb-4 text-green-400 border-b border-gray-600 pb-2">æ›²ã‚’è¿½åŠ </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-400 text-xs mb-1">è¿½åŠ è€…å (ãƒãƒ³ãƒ‡æˆ¦ç”¨)</label>
                        <input type="text" id="addedBy"
                            class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-sm focus:outline-none focus:border-green-500"
                            placeholder="ã‚ãªãŸã®åå‰">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-xs mb-1">YouTube URL / Share Link</label>
                        <div class="flex">
                            <input type="text" id="ytUrl"
                                class="flex-grow p-2 rounded bg-gray-700 border border-gray-600 text-sm focus:outline-none focus:border-green-500"
                                placeholder="https://youtu.be/...">
                            <button onclick="fetchMetadata()"
                                class="ml-2 bg-blue-600 px-3 rounded text-sm font-bold">å–å¾—</button>
                        </div>
                    </div>

                    <div id="previewArea" class="hidden bg-black p-2 rounded text-center">
                        <img id="thumb" class="w-full h-32 object-cover rounded opacity-50 mb-2">
                        <div class="text-xs text-gray-400" id="videoTitle"></div>
                    </div>

                    <div>
                        <label class="block text-gray-400 text-xs mb-1">æ­£è§£ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰</label>
                        <input type="text" id="titleMain"
                            class="w-full p-2 rounded bg-gray-700 border border-gray-600 font-bold" placeholder="æ›²å">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-xs mb-1">æ­£è§£ï¼ˆã²ã‚‰ãŒãª/åˆ¥åï¼‰- æ”¹è¡Œã§è¤‡æ•°ç™»éŒ²å¯</label>
                        <textarea id="titleHira" class="w-full p-2 rounded bg-gray-700 border border-gray-600" rows="3"
                            placeholder="ã‚ˆã¿ãŒãª (ä»»æ„)&#10;åˆ¥å1&#10;åˆ¥å2"></textarea>
                    </div>

                    <button onclick="addSong()"
                        class="w-full bg-green-600 hover:bg-green-700 py-3 rounded font-bold shadow-lg">
                        ãƒªã‚¹ãƒˆã«è¿½åŠ  â•
                    </button>
                    <p class="text-xs text-center text-gray-500 mt-2">â€»é¸æŠä¸­ã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¾ã™</p>
                </div>

                <!-- ä¸€æ‹¬è¿½åŠ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="mt-6 pt-6 border-t border-gray-600">
                    <h3 class="text-lg font-bold mb-3 text-purple-400">ğŸ“‹ ä¸€æ‹¬è¿½åŠ </h3>

                    <!-- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURLã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
                    <div class="space-y-3 mb-4 pb-4 border-b border-gray-700">
                        <div>
                            <label class="block text-gray-400 text-xs mb-1">ğŸµ YouTubeãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURL</label>
                            <input type="text" id="playlistUrl"
                                class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-sm focus:outline-none focus:border-pink-500"
                                placeholder="https://www.youtube.com/playlist?list=...">
                        </div>
                        <button onclick="importPlaylist()"
                            class="w-full bg-pink-600 hover:bg-pink-700 py-2 rounded font-bold shadow-lg text-sm">
                            ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ğŸ¶
                        </button>
                        <div id="playlistProgress" class="hidden">
                            <div class="bg-gray-700 rounded-full h-2 overflow-hidden">
                                <div id="playlistProgressBar" class="bg-pink-500 h-full transition-all duration-200"
                                    style="width: 0%"></div>
                            </div>
                            <p id="playlistProgressText" class="text-xs text-gray-400 mt-1 text-center">0 / 0</p>
                        </div>
                    </div>

                    <!-- è¤‡æ•°URLä¸€æ‹¬è¿½åŠ  -->
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-400 text-xs mb-1">ğŸ“ YouTube URLï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰</label>
                            <textarea id="bulkUrls"
                                class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-sm focus:outline-none focus:border-purple-500"
                                rows="4" placeholder="https://youtu.be/xxx&#10;https://youtu.be/yyy"></textarea>
                        </div>
                        <button onclick="bulkAddSongs()"
                            class="w-full bg-purple-600 hover:bg-purple-700 py-2 rounded font-bold shadow-lg text-sm">
                            URLä¸€æ‹¬è¿½åŠ  ğŸ“¥
                        </button>
                        <div id="bulkProgress" class="hidden">
                            <div class="bg-gray-700 rounded-full h-2 overflow-hidden">
                                <div id="bulkProgressBar" class="bg-purple-500 h-full transition-all duration-200"
                                    style="width: 0%"></div>
                            </div>
                            <p id="bulkProgressText" class="text-xs text-gray-400 mt-1 text-center">0 / 0</p>
                        </div>
                        <p class="text-xs text-center text-gray-500">âš ï¸ ä¸€æ‹¬è¿½åŠ ã•ã‚ŒãŸæ›²ã¯ã€Œæœªç·¨é›†ã€çŠ¶æ…‹ã§ã™ã€‚<br>ç·¨é›†ã™ã‚‹ã¾ã§ã‚¯ã‚¤ã‚ºã«ã¯å‡ºé¡Œã•ã‚Œã¾ã›ã‚“ã€‚</p>
                    </div>
                </div>
            </div>

            <!-- Song List -->
            <div class="w-full md:w-2/3 p-6 overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex flex-col">
                        <h2 class="text-2xl font-bold text-white flex items-center">
                            <span id="currentListPrivateIcon" class="hidden mr-1">ğŸ”’</span>
                            <span id="currentListName" class="text-yellow-400">Global</span>
                            <span class="text-sm font-normal text-gray-400 ml-2">(<span id="songCount">0</span>æ›²)</span>
                        </h2>
                        <div class="flex space-x-2 mt-2 flex-wrap gap-1">
                            <button onclick="renameCurrentPlaylist()"
                                class="text-xs bg-indigo-700 hover:bg-indigo-600 px-2 py-1 rounded">âœï¸ åå‰å¤‰æ›´</button>
                            <button onclick="togglePrivacy()" id="togglePrivacyBtn"
                                class="text-xs bg-indigo-700 hover:bg-indigo-600 px-2 py-1 rounded">ğŸ”“ å…¬é–‹</button>
                            <button onclick="toggleEditable()" id="toggleEditableBtn"
                                class="text-xs bg-indigo-700 hover:bg-indigo-600 px-2 py-1 rounded">âœ… ç·¨é›†å¯</button>
                            <button onclick="copyCurrentPlaylist()"
                                class="text-xs bg-indigo-700 hover:bg-indigo-600 px-2 py-1 rounded">ğŸ“‹ è¤‡è£½</button>
                            <button onclick="deleteCurrentPlaylist()"
                                class="text-xs bg-red-700 hover:bg-red-600 px-2 py-1 rounded">ğŸ—‘ï¸ å‰Šé™¤</button>
                        </div>
                    </div>
                </div>

                <!-- Search Box and Sort -->
                <div class="mb-4 flex gap-2">
                    <input type="text" id="songSearch" placeholder="ğŸ” æ›²åã§æ¤œç´¢..."
                        class="flex-grow p-2 rounded bg-gray-700 border border-gray-600 text-sm focus:outline-none focus:border-green-500"
                        oninput="filterSongs()">
                    <select id="songSort" onchange="filterSongs()"
                        class="p-2 rounded bg-gray-700 border border-gray-600 text-sm focus:outline-none focus:border-green-500">
                        <option value="addedDesc">â›³ è¿½åŠ æ—¥ (æ–°ã—ã„é †)</option>
                        <option value="addedAsc">â›³ è¿½åŠ æ—¥ (å¤ã„é †)</option>
                        <option value="titleAsc">ğŸµ æ›²å (A-Z)</option>
                        <option value="titleDesc">ğŸµ æ›²å (Z-A)</option>
                        <option value="addedByAsc">ğŸ‘¤ è¿½åŠ è€… (A-Z)</option>
                    </select>
                </div>

                <div id="songsContainer" class="grid grid-cols-1 gap-3"></div>
            </div>

        </div>

    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 p-6 rounded-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-yellow-400">æ›²æƒ…å ±ã‚’ç·¨é›†</h3>
            <input type="hidden" id="editSongId">
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-400 text-xs mb-1">æ­£è§£ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰</label>
                    <input type="text" id="editTitleMain"
                        class="w-full p-2 rounded bg-gray-700 border border-gray-600 font-bold">
                </div>
                <div>
                    <label class="block text-gray-400 text-xs mb-1">æ­£è§£ï¼ˆã²ã‚‰ãŒãª/åˆ¥åï¼‰- æ”¹è¡Œã§è¤‡æ•°ç™»éŒ²å¯</label>
                    <textarea id="editTitleHira" class="w-full p-2 rounded bg-gray-700 border border-gray-600"
                        rows="3"></textarea>
                </div>
                <div>
                    <label class="block text-gray-400 text-xs mb-1">è¿½åŠ è€…å (ãƒãƒ³ãƒ‡æˆ¦ç”¨)</label>
                    <div class="flex space-x-2">
                        <input type="text" id="editAddedBy"
                            class="flex-grow p-2 rounded bg-gray-700 border border-gray-600">
                        <button onclick="linkToMe()"
                            class="bg-pink-600 hover:bg-pink-700 px-3 rounded text-xs font-bold whitespace-nowrap">ğŸ”—
                            è‡ªåˆ†ã«ç´ã¥ã‘</button>
                    </div>
                    <input type="hidden" id="editAddedByUUID">
                </div>
                <div class="flex space-x-2">
                    <button onclick="saveEdit()"
                        class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded font-bold">ä¿å­˜</button>
                    <button onclick="closeEditModal()"
                        class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 rounded font-bold">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPlaylistId = 'global';
        let currentPlaylistName = 'Global (Default)';
        let activeListenerRef = null;
        let currentSongs = {}; // Store current songs for filtering

        async function init() {
            if (!window.VibeQuiz || !window.VibeQuiz.db) { setTimeout(init, 500); return; }

            const db = window.VibeQuiz.db;

            db.ref('playlists').on('value', snap => {
                const el = document.getElementById('playlistList');
                el.innerHTML = '';
                const data = snap.val() || {};
                const myUserId = localStorage.getItem('vibeQuizUserId') || '';

                Object.entries(data).forEach(([key, val]) => {
                    // â˜… å€‹äººç”¨ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã¯è‡ªåˆ†ã®ã‚‚ã®ã ã‘è¡¨ç¤º â˜…
                    if (val.isPrivate && val.ownerUUID !== myUserId) return;

                    const div = document.createElement('div');
                    const isActive = key === currentPlaylistId;
                    const isPrivate = val.isPrivate;
                    div.id = `pl-${key}`;
                    div.className = `p-3 rounded cursor-pointer transition hover:bg-indigo-800 ${isActive ? 'bg-indigo-700 border-l-4 border-pink-500' : 'bg-indigo-900/50'}`;
                    div.innerHTML = `
                        <div class="font-bold text-sm">${isPrivate ? 'ğŸ”’ ' : ''}${val.name}</div>
                        ${isPrivate ? '<div class="text-[10px] text-gray-400">å€‹äººç”¨</div>' : ''}
                    `;
                    div.onclick = () => selectPlaylist(key, val.name);
                    el.appendChild(div);
                });

                updateHighlights();
            });

            selectPlaylist('global', 'Global (Default)');
        }

        async function createPlaylist() {
            if (!window.VibeQuiz) { alert("èª­è¾¼ä¸­..."); return; }
            const name = prompt("æ–°ã—ã„ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå:");
            if (!name) return;

            try {
                await window.VibeQuiz.createPlaylist(name, false);
            } catch (e) {
                alert("ä½œæˆã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        }

        async function createPrivatePlaylist() {
            if (!window.VibeQuiz) { alert("èª­è¾¼ä¸­..."); return; }
            const name = prompt("å€‹äººç”¨ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå:");
            if (!name) return;

            try {
                await window.VibeQuiz.createPlaylist(name, true);
                alert("å€‹äººç”¨ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚\nã“ã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã¯ã‚ãªãŸãŒãƒ›ã‚¹ãƒˆã®æ™‚ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚");
            } catch (e) {
                alert("ä½œæˆã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        }

        async function renameCurrentPlaylist() {
            if (currentPlaylistId === 'global') { alert("Globalãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã¯å¤‰æ›´ã§ãã¾ã›ã‚“"); return; }
            const newName = prompt("æ–°ã—ã„åå‰:", currentPlaylistName);
            if (!newName || newName === currentPlaylistName) return;

            try {
                await window.VibeQuiz.renamePlaylist(currentPlaylistId, newName);
                currentPlaylistName = newName;
                document.getElementById('currentListName').innerText = newName;
            } catch (e) { alert("å¤‰æ›´ã‚¨ãƒ©ãƒ¼: " + e.message); }
        }

        async function copyCurrentPlaylist() {
            if (!confirm(`ã€Œ${currentPlaylistName}ã€ã‚’è¤‡è£½ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            try {
                await window.VibeQuiz.duplicatePlaylist(currentPlaylistId);
                alert("è¤‡è£½ã—ã¾ã—ãŸï¼");
            } catch (e) { alert("è¤‡è£½ã‚¨ãƒ©ãƒ¼: " + e.message); }
        }

        async function deleteCurrentPlaylist() {
            if (currentPlaylistId === 'global') {
                alert("Globalãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“");
                return;
            }
            if (!confirm(`ã€Œ${currentPlaylistName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) return;
            try {
                await window.VibeQuiz.deletePlaylist(currentPlaylistId);
                selectPlaylist('global', 'Global (Default)');
                alert("å‰Šé™¤ã—ã¾ã—ãŸ");
            } catch (e) { alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message); }
        }

        let currentPlaylistIsPrivate = false;  // â˜… è¿½åŠ  â˜…

        async function selectPlaylist(id, name) {
            currentPlaylistId = id;
            currentPlaylistName = name;
            document.getElementById('currentListName').innerText = name;

            const db = window.VibeQuiz.db;
            const path = id === 'global' ? 'playlist' : `playlists/${id}/songs`;

            if (activeListenerRef) activeListenerRef.off();

            activeListenerRef = db.ref(path);
            activeListenerRef.on('value', snap => {
                const sortKey = document.getElementById('songSort')?.value || 'addedDesc';
                renderSongs(snap.val() || {}, '', sortKey);
            });

            // â˜… ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆæƒ…å ±å–å¾—ã—ã¦isPrivate/editableè¡¨ç¤ºæ›´æ–° â˜…
            const myUserId = localStorage.getItem('vibeQuizUserId') || '';
            if (id === 'global') {
                currentPlaylistIsPrivate = false;
                currentPlaylistIsEditable = true;
                currentPlaylistIsCreator = false;
                updatePrivacyUI(false);
                updateEditableUI(true, false);
            } else {
                try {
                    const info = await window.VibeQuiz.getPlaylistInfo(id);
                    currentPlaylistIsPrivate = info ? info.isPrivate : false;
                    currentPlaylistIsEditable = info ? info.editable : true;
                    currentPlaylistIsCreator = info && info.creatorUUID === myUserId;
                    updatePrivacyUI(currentPlaylistIsPrivate);
                    updateEditableUI(currentPlaylistIsEditable, currentPlaylistIsCreator);
                } catch (e) {
                    updatePrivacyUI(false);
                    updateEditableUI(true, false);
                }
            }

            updateHighlights();
        }

        function updatePrivacyUI(isPrivate) {
            const icon = document.getElementById('currentListPrivateIcon');
            const btn = document.getElementById('togglePrivacyBtn');
            if (isPrivate) {
                icon.classList.remove('hidden');
                btn.innerHTML = 'ğŸ”’ å€‹äººç”¨';
                btn.className = 'text-xs bg-yellow-700 hover:bg-yellow-600 px-2 py-1 rounded';
            } else {
                icon.classList.add('hidden');
                btn.innerHTML = 'ğŸ”“ å…¬é–‹';
                btn.className = 'text-xs bg-indigo-700 hover:bg-indigo-600 px-2 py-1 rounded';
            }
            // Globalã®å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            if (currentPlaylistId === 'global') {
                btn.classList.add('hidden');
            } else {
                btn.classList.remove('hidden');
            }
        }

        function updateEditableUI(editable, isCreator) {
            const btn = document.getElementById('toggleEditableBtn');
            if (editable) {
                btn.innerHTML = 'âœ… ç·¨é›†å¯';
                btn.className = 'text-xs bg-green-700 hover:bg-green-600 px-2 py-1 rounded';
            } else {
                btn.innerHTML = 'ğŸš« ç·¨é›†ä¸å¯';
                btn.className = 'text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded';
            }
            // Globalã®å ´åˆã¾ãŸã¯ä½œæˆè€…ã§ãªã„å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            if (currentPlaylistId === 'global' || !isCreator) {
                btn.classList.add('hidden');
            } else {
                btn.classList.remove('hidden');
            }
        }

        async function togglePrivacy() {
            if (currentPlaylistId === 'global') return;
            const newPrivacy = !currentPlaylistIsPrivate;
            try {
                await window.VibeQuiz.togglePlaylistPrivacy(currentPlaylistId, newPrivacy);
                currentPlaylistIsPrivate = newPrivacy;
                updatePrivacyUI(newPrivacy);
                alert(newPrivacy ? 'å€‹äººç”¨ã«å¤‰æ›´ã—ã¾ã—ãŸï¼ˆè‡ªåˆ†ã ã‘ãŒè¦‹ãˆã¾ã™ï¼‰' : 'å…¬é–‹ã«å¤‰æ›´ã—ã¾ã—ãŸï¼ˆå…¨å“¡ãŒè¦‹ãˆã¾ã™ï¼‰');
            } catch (e) {
                alert('å¤‰æ›´ã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }

        let currentPlaylistIsEditable = true;
        let currentPlaylistIsCreator = false;

        async function toggleEditable() {
            if (currentPlaylistId === 'global') return;
            if (!currentPlaylistIsCreator) {
                alert('ä½œæˆè€…ã®ã¿ãŒç·¨é›†å¯èƒ½è¨­å®šã‚’å¤‰æ›´ã§ãã¾ã™');
                return;
            }
            const newEditable = !currentPlaylistIsEditable;
            try {
                await window.VibeQuiz.togglePlaylistEditable(currentPlaylistId, newEditable);
                currentPlaylistIsEditable = newEditable;
                updateEditableUI(newEditable, true);
                alert(newEditable ? 'ä»–ã®äººã‚‚ç·¨é›†ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ' : 'ä»–ã®äººã¯ç·¨é›†ã§ããªããªã‚Šã¾ã—ãŸ');
            } catch (e) {
                alert('å¤‰æ›´ã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }

        function updateHighlights() {
            const gEl = document.getElementById('pl-global');
            if (gEl) gEl.className = `p-3 rounded cursor-pointer transition hover:bg-indigo-800 ${currentPlaylistId === 'global' ? 'bg-indigo-700 border-l-4 border-yellow-400' : 'bg-indigo-700'}`;

            const list = document.getElementById('playlistList');
            Array.from(list.children).forEach(child => {
                const key = child.id.replace('pl-', '');
                child.className = `p-3 rounded cursor-pointer transition hover:bg-indigo-800 ${key === currentPlaylistId ? 'bg-indigo-700 border-l-4 border-pink-500' : 'bg-indigo-900/50'}`;
            });
        }

        function filterSongs() {
            const query = document.getElementById('songSearch').value;
            const sortKey = document.getElementById('songSort').value;
            renderSongs(currentSongs, query, sortKey);
        }

        function sortSongs(entries, sortKey) {
            return entries.sort((a, b) => {
                const [keyA, songA] = a;
                const [keyB, songB] = b;

                // Helper to get reading or main title
                const getTitle = (s) => (s.titleHira || s.titleMain || '').toLowerCase();

                switch (sortKey) {
                    case 'addedDesc':
                        if (keyA > keyB) return -1;
                        if (keyA < keyB) return 1;
                        return 0;
                    case 'addedAsc':
                        if (keyA > keyB) return 1;
                        if (keyA < keyB) return -1;
                        return 0;
                    case 'titleAsc':
                        return getTitle(songA).localeCompare(getTitle(songB), 'ja');
                    case 'titleDesc':
                        return getTitle(songB).localeCompare(getTitle(songA), 'ja');
                    case 'addedByAsc':
                        return (songA.addedBy || '').localeCompare(songB.addedBy || '', 'ja');
                    default:
                        return 0;
                }
            });
        }

        function renderSongs(songs, searchQuery = '', sortKey = 'addedDesc') {
            currentSongs = songs; // Store for filtering
            const el = document.getElementById('songsContainer');
            el.innerHTML = '';

            // Filter by search query
            const filteredEntries = Object.entries(songs).filter(([key, song]) => {
                if (!searchQuery) return true;
                const q = searchQuery.toLowerCase();
                return (song.titleMain && song.titleMain.toLowerCase().includes(q)) ||
                    (song.titleHira && song.titleHira.toLowerCase().includes(q)) ||
                    (song.addedBy && song.addedBy.toLowerCase().includes(q));
            });

            // ç·¨é›†æ¸ˆã¿/æœªç·¨é›†ã®æ›²æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const totalCount = Object.keys(songs).length;
            const editedCount = Object.values(songs).filter(s => s.isEdited !== false).length;
            const uneditedCount = totalCount - editedCount;
            document.getElementById('songCount').innerHTML = uneditedCount > 0
                ? `${editedCount}<span class="text-gray-500">+${uneditedCount}æœªç·¨é›†</span>`
                : `${totalCount}`;

            if (!songs || Object.keys(songs).length === 0) {
                el.innerHTML = '<div class="text-gray-500 p-4">æ›²ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            if (filteredEntries.length === 0) {
                el.innerHTML = '<div class="text-gray-500 p-4">æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // â˜… ã‚½ãƒ¼ãƒˆé©ç”¨ â˜…
            const sortedEntries = sortSongs(filteredEntries, sortKey);

            sortedEntries.forEach(([key, song]) => {
                const div = document.createElement('div');
                const isUnedited = song.isEdited === false;
                div.className = `bg-gray-800 p-3 rounded flex items-center space-x-4 hover:bg-gray-700 transition group ${isUnedited ? 'border-l-4 border-yellow-500' : ''}`;
                const uneditedBadge = isUnedited ? '<span class="bg-yellow-600 text-black text-[10px] px-1 rounded ml-1">âš ï¸æœªç·¨é›†</span>' : '';
                div.innerHTML = `
                    <img src="${song.thumbnail}" class="w-16 h-9 object-cover rounded bg-black">
                    <div class="flex-grow">
                        <a href="https://www.youtube.com/watch?v=${song.youtubeId}" target="_blank" 
                           class="font-bold text-white text-sm line-clamp-1 hover:text-pink-400 hover:underline cursor-pointer">
                            ${song.titleMain}${uneditedBadge}
                        </a>
                        <div class="text-xs text-gray-400 line-clamp-1">${song.titleHira || '-'}</div>
                        ${song.addedBy ? `<div class="text-[10px] text-pink-400">by ${song.addedBy}</div>` : ''}
                    </div>
                `;

                // â˜…â˜…â˜… Edit Button â˜…â˜…â˜…
                const editBtn = document.createElement('button');
                editBtn.className = "bg-blue-600 text-white px-3 py-1 rounded text-xs opacity-50 group-hover:opacity-100 transition";
                editBtn.innerText = "ç·¨é›†";
                editBtn.onclick = () => openEditModal(key, song);
                div.appendChild(editBtn);

                const delBtn = document.createElement('button');
                delBtn.className = "bg-red-600 text-white px-3 py-1 rounded text-xs opacity-50 group-hover:opacity-100 transition";
                delBtn.innerText = "å‰Šé™¤";
                delBtn.onclick = () => deleteSong(key);
                div.appendChild(delBtn);

                el.appendChild(div);
            });
        }

        // â˜…â˜…â˜… Edit Modal Functions â˜…â˜…â˜…
        function openEditModal(songId, song) {
            document.getElementById('editSongId').value = songId;
            document.getElementById('editTitleMain').value = song.titleMain || '';
            document.getElementById('editTitleHira').value = song.titleHira || '';
            document.getElementById('editAddedBy').value = song.addedBy || '';
            document.getElementById('editAddedByUUID').value = song.addedByUUID || '';
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        // â˜…â˜…â˜… è‡ªåˆ†ã«ç´ã¥ã‘æ©Ÿèƒ½ â˜…â˜…â˜…
        function linkToMe() {
            const nickname = localStorage.getItem('vibeQuizNickname') || '';
            const uuid = window.VibeQuiz.getUserId ? window.VibeQuiz.getUserId() : null;

            if (!nickname) {
                alert("ãƒ­ãƒ“ãƒ¼ç”»é¢ã§ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’è¨­å®šã—ã¦ã‹ã‚‰ä½¿ç”¨ã—ã¦ãã ã•ã„");
                return;
            }

            document.getElementById('editAddedBy').value = nickname;
            document.getElementById('editAddedByUUID').value = uuid || '';
            alert(`ã€Œ${nickname}ã€ã«ç´ã¥ã‘ã¾ã—ãŸï¼\nä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ç¢ºå®šã—ã¦ãã ã•ã„ã€‚`);
        }

        async function saveEdit() {
            const songId = document.getElementById('editSongId').value;
            const newMain = document.getElementById('editTitleMain').value.trim();
            const newHira = document.getElementById('editTitleHira').value.trim();
            const newAddedBy = document.getElementById('editAddedBy').value.trim();
            const newAddedByUUID = document.getElementById('editAddedByUUID').value.trim();

            if (!newMain) { alert("æ­£è§£ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

            try {
                await window.VibeQuiz.updateSong(currentPlaylistId, songId, {
                    titleMain: newMain,
                    titleHira: newHira,
                    addedBy: newAddedBy || null,
                    addedByUUID: newAddedByUUID || null,
                    isEdited: true  // â˜… ç·¨é›†æ¸ˆã¿ãƒ•ãƒ©ã‚° â˜…
                });
                closeEditModal();
            } catch (e) {
                alert("æ›´æ–°ã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        }

        function extractVideoId(url) {
            let videoId = "";
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            if (match && match[7].length == 11) videoId = match[7];
            return videoId;
        }

        async function fetchMetadata() {
            const url = document.getElementById('ytUrl').value;
            const videoId = extractVideoId(url);

            if (!videoId) { alert("æœ‰åŠ¹ãªYouTube URLã§ã¯ã‚ã‚Šã¾ã›ã‚“"); return; }

            const thumb = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
            document.getElementById('thumb').src = thumb;
            document.getElementById('previewArea').classList.remove('hidden');
            document.getElementById('ytUrl').dataset.videoId = videoId;
        }

        async function addSong() {
            if (!window.VibeQuiz) { alert("Firebaseèª­è¾¼ä¸­..."); return; }

            let videoId = document.getElementById('ytUrl').dataset.videoId;

            if (!videoId) {
                const rawUrl = document.getElementById('ytUrl').value;
                videoId = extractVideoId(rawUrl);
            }

            const main = document.getElementById('titleMain').value;
            const hira = document.getElementById('titleHira').value;
            const addedBy = document.getElementById('addedBy').value.trim();

            if (!videoId || !main) { alert("URL(ã¾ãŸã¯å‹•ç”»ID)ã¨æ­£è§£ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼"); return; }

            // Check for duplicates
            const existingSongs = Object.values(currentSongs);
            const duplicate = existingSongs.find(s => s.youtubeId === videoId);
            if (duplicate) {
                alert(`âš ï¸ ã“ã®æ›²ã¯æ—¢ã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã«å­˜åœ¨ã—ã¾ã™ï¼\næ›²å: ${duplicate.titleMain}`);
                return;
            }

            try {
                // UUIDã‚’å–å¾—ï¼ˆãƒãƒ³ãƒ‡æˆ¦ç”¨ï¼‰
                const addedByUUID = window.VibeQuiz.getUserId ? window.VibeQuiz.getUserId() : null;

                await window.VibeQuiz.addSongToPlaylist(currentPlaylistId, {
                    youtubeId: videoId,
                    titleMain: main,
                    titleHira: hira,
                    thumbnail: `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`,
                    addedBy: addedBy || null,
                    addedByUUID: addedByUUID  // UUID ã‚‚ä¿å­˜
                });

                document.getElementById('ytUrl').value = '';
                document.getElementById('ytUrl').dataset.videoId = '';
                document.getElementById('titleMain').value = '';
                document.getElementById('titleHira').value = '';
                // Keep addedBy for convenience when adding multiple songs
                document.getElementById('previewArea').classList.add('hidden');
            } catch (e) {
                alert("è¿½åŠ ã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        }

        async function deleteSong(key) {
            if (confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                await window.VibeQuiz.deleteSong(currentPlaylistId, key);
            }
        }

        // â˜…â˜…â˜… ä¸€æ‹¬è¿½åŠ æ©Ÿèƒ½ â˜…â˜…â˜…
        async function bulkAddSongs() {
            if (!window.VibeQuiz) { alert("Firebaseèª­è¾¼ä¸­..."); return; }

            const textarea = document.getElementById('bulkUrls');
            const urls = textarea.value.split(/[\r\n]+/).map(u => u.trim()).filter(u => u);

            if (urls.length === 0) {
                alert("URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }

            const progressEl = document.getElementById('bulkProgress');
            const progressBar = document.getElementById('bulkProgressBar');
            const progressText = document.getElementById('bulkProgressText');
            progressEl.classList.remove('hidden');

            let added = 0;
            let skipped = 0;
            const existingIds = Object.values(currentSongs).map(s => s.youtubeId);

            for (let i = 0; i < urls.length; i++) {
                const url = urls[i];
                const videoId = extractVideoId(url);

                // é€²æ—è¡¨ç¤ºæ›´æ–°
                const percent = ((i + 1) / urls.length) * 100;
                progressBar.style.width = percent + '%';
                progressText.textContent = `${i + 1} / ${urls.length}`;

                if (!videoId) {
                    skipped++;
                    continue;
                }

                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                if (existingIds.includes(videoId)) {
                    skipped++;
                    continue;
                }

                try {
                    await window.VibeQuiz.addSongToPlaylist(currentPlaylistId, {
                        youtubeId: videoId,
                        titleMain: `ã€æœªç·¨é›†ã€‘${videoId}`,  // ä»®ã‚¿ã‚¤ãƒˆãƒ«
                        titleHira: '',
                        thumbnail: `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`,
                        addedBy: null,
                        addedByUUID: null,
                        isEdited: false  // â˜… æœªç·¨é›†ãƒ•ãƒ©ã‚° â˜…
                    });
                    existingIds.push(videoId);
                    added++;
                } catch (e) {
                    console.error(`Failed to add ${videoId}:`, e);
                    skipped++;
                }
            }

            // å®Œäº†
            setTimeout(() => {
                progressEl.classList.add('hidden');
                progressBar.style.width = '0%';
                textarea.value = '';
                alert(`å®Œäº†ï¼\nè¿½åŠ : ${added}æ›²\nã‚¹ã‚­ãƒƒãƒ—: ${skipped}æ›²\n\nâš ï¸ è¿½åŠ ã•ã‚ŒãŸæ›²ã¯ã€Œæœªç·¨é›†ã€çŠ¶æ…‹ã§ã™ã€‚\nç·¨é›†ãƒœã‚¿ãƒ³ã‹ã‚‰æ›²åã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚`);
            }, 500);
        }
        // â˜…â˜…â˜… YouTubeãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ â˜…â˜…â˜…
        // APIã‚­ãƒ¼è¨­å®šï¼ˆGoogle Cloud Consoleã‹ã‚‰YouTube Data API v3ã®ã‚­ãƒ¼ã‚’å–å¾—ã—ã¦è¨­å®šï¼‰
        const YOUTUBE_API_KEY = localStorage.getItem('youtubeApiKey') || '';

        async function importPlaylist() {
            const url = document.getElementById('playlistUrl').value.trim();

            // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆIDã‚’æŠ½å‡º
            const listMatch = url.match(/[?&]list=([^&]+)/);
            if (!listMatch) {
                alert('æœ‰åŠ¹ãªYouTubeãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURLã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\nä¾‹: https://www.youtube.com/playlist?list=PLxxxx');
                return;
            }
            const playlistId = listMatch[1];

            // APIã‚­ãƒ¼ãƒã‚§ãƒƒã‚¯
            if (!YOUTUBE_API_KEY) {
                const key = prompt('YouTube Data API ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n\nâ€» Google Cloud Consoleã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚\nâ€» ä¸€åº¦å…¥åŠ›ã™ã‚‹ã¨ä¿å­˜ã•ã‚Œã¾ã™ã€‚');
                if (!key) return;
                localStorage.setItem('youtubeApiKey', key);
                location.reload();
                return;
            }

            const progressEl = document.getElementById('playlistProgress');
            const progressBar = document.getElementById('playlistProgressBar');
            const progressText = document.getElementById('playlistProgressText');
            progressEl.classList.remove('hidden');
            progressText.textContent = 'å–å¾—ä¸­...';

            try {
                // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
                const items = [];
                let nextPageToken = '';

                do {
                    const apiUrl = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${playlistId}&key=${YOUTUBE_API_KEY}${nextPageToken ? `&pageToken=${nextPageToken}` : ''}`;
                    const response = await fetch(apiUrl);

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || 'API ã‚¨ãƒ©ãƒ¼');
                    }

                    const data = await response.json();
                    items.push(...data.items);
                    nextPageToken = data.nextPageToken || '';

                    progressText.textContent = `å–å¾—ä¸­... ${items.length}ä»¶`;
                } while (nextPageToken);

                if (items.length === 0) {
                    alert('ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒç©ºã‹ã€éå…¬é–‹ã§ã™ã€‚');
                    progressEl.classList.add('hidden');
                    return;
                }

                // æ›²ã‚’è¿½åŠ 
                const existingIds = Object.values(currentSongs).map(s => s.youtubeId);
                let added = 0;
                let skipped = 0;

                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    const videoId = item.snippet?.resourceId?.videoId;
                    const title = item.snippet?.title || '';

                    if (!videoId || title === 'Private video' || title === 'Deleted video') {
                        skipped++;
                        continue;
                    }

                    if (existingIds.includes(videoId)) {
                        skipped++;
                        continue;
                    }

                    // é€²æ—è¡¨ç¤º
                    const percent = ((i + 1) / items.length) * 100;
                    progressBar.style.width = percent + '%';
                    progressText.textContent = `${i + 1} / ${items.length}`;

                    try {
                        await window.VibeQuiz.addSongToPlaylist(currentPlaylistId, {
                            youtubeId: videoId,
                            titleMain: `ã€æœªç·¨é›†ã€‘${title}`,
                            titleHira: '',
                            thumbnail: `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`,
                            addedBy: null,
                            addedByUUID: null,
                            isEdited: false
                        });
                        existingIds.push(videoId);
                        added++;
                    } catch (e) {
                        console.error(`Failed to add ${videoId}:`, e);
                        skipped++;
                    }
                }

                setTimeout(() => {
                    progressEl.classList.add('hidden');
                    progressBar.style.width = '0%';
                    document.getElementById('playlistUrl').value = '';
                    alert(`å®Œäº†ï¼\nè¿½åŠ : ${added}æ›²\nã‚¹ã‚­ãƒƒãƒ—: ${skipped}æ›²\n\nâš ï¸ è¿½åŠ ã•ã‚ŒãŸæ›²ã¯ã€Œæœªç·¨é›†ã€çŠ¶æ…‹ã§ã™ã€‚\nç·¨é›†ãƒœã‚¿ãƒ³ã‹ã‚‰æ›²åã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚`);
                }, 500);

            } catch (e) {
                progressEl.classList.add('hidden');
                alert('ã‚¨ãƒ©ãƒ¼: ' + e.message + '\n\nAPIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                console.error('Playlist import error:', e);
            }
        }

        init();

    </script>
</body>

</html>