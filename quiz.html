<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿ºé”ã®ã‚¤ãƒ³ãƒˆãƒ­ã‚¯ã‚¤ã‚ºï¼ - Play</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            touch-action: manipulation;
        }

        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* ã‚¹ãƒãƒ›ã§ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’ã»ã¼ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã« */
        @media (max-width: 768px) {
            #memberListPanel {
                width: 90vw !important;
                max-width: 90vw !important;
            }
        }
    </style>
</head>

<body class="bg-indigo-900 text-white h-screen flex flex-col overflow-hidden relative">

    <!-- Start Overlay -->
    <div id="startOverlay"
        class="fixed inset-0 bg-black/80 z-[100] flex flex-col items-center justify-center cursor-pointer">
        <div class="bg-indigo-600 p-8 rounded-2xl shadow-2xl text-center border-4 border-white animate-bounce">
            <h1 class="text-3xl font-bold mb-4">ğŸµ ã‚¯ã‚¤ã‚ºã«å‚åŠ </h1>
            <p class="text-xl">ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆï¼</p>
            <p class="text-sm mt-2 opacity-75">â€»éŸ³å£°ãŒå†ç”Ÿã•ã‚Œã¾ã™</p>
        </div>
    </div>

    <!-- Header -->
    <div
        class="bg-indigo-800 p-4 shadow-md flex justify-between items-center z-30 shrink-0 border-b border-indigo-600 relative">
        <h1 class="font-bold text-lg text-yellow-500">ä¿ºé”ã®ã‚¤ãƒ³ãƒˆãƒ­ã‚¯ã‚¤ã‚ºï¼</h1>
        <div class="flex items-center space-x-2">
            <div class="text-xs bg-indigo-950 px-2 py-1 rounded text-gray-400">ROOM: <span id="roomIdDisp"
                    class="text-white font-mono font-bold">...</span></div>
            <div id="headerStatus" class="text-sm font-mono text-gray-300 font-bold bg-black/30 px-3 py-1 rounded">
                WAITING</div>
        </div>
    </div>

    <button onclick="window.forceAudio()"
        class="absolute top-16 right-4 z-50 bg-gray-700 text-xs px-2 py-1 rounded opacity-50 hover:opacity-100">ğŸ”Š</button>

    <!-- Main Content -->
    <div class="flex-grow relative flex flex-col md:flex-row items-stretch justify-center overflow-hidden w-full z-20">

        <!-- Sidebar -->
        <div id="memberListPanel"
            class="absolute md:relative md:w-1/4 h-full p-4 bg-indigo-900/95 z-40 flex flex-col items-center justify-start overflow-y-auto w-64 top-0 left-0 transition-transform duration-300 transform -translate-x-full md:translate-x-0 border-r border-indigo-700 shrink-0 shadow-xl pb-safe">
            <div class="w-full flex justify-between items-center mb-4 border-b border-pink-500 pb-2">
                <h2 class="text-xl font-bold text-pink-300">å‚åŠ è€…ãƒªã‚¹ãƒˆ</h2>
                <button onclick="document.getElementById('memberListPanel').classList.add('-translate-x-full')"
                    class="md:hidden bg-red-600 hover:bg-red-500 p-3 rounded-lg text-2xl font-bold">âœ–</button>
            </div>
            <ul id="participantsListHost" class="w-full space-y-2"></ul>

            <!-- è¦³æˆ¦è€…ãƒªã‚¹ãƒˆ -->
            <div id="spectatorSection" class="hidden w-full mt-4 pt-3 border-t border-gray-500">
                <h3 class="text-sm font-bold text-gray-400 mb-2">ğŸ‘ï¸ è¦³æˆ¦ä¸­</h3>
                <ul id="spectatorsList" class="w-full space-y-1 text-sm text-gray-300"></ul>
            </div>

            <!-- Host Control Panel -->
            <div id="hostControlPanel" class="hidden w-full mt-4 pt-4 border-t border-pink-500">
                <h3 class="text-lg font-bold text-yellow-400 mb-3 text-center">ğŸ‘‘ ãƒ›ã‚¹ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h3>
                <div class="space-y-2">
                    <button id="hostStartBtn"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-sm shadow-lg transform active:scale-95 transition">
                        â–¶ ã‚²ãƒ¼ãƒ é–‹å§‹ / æ¬¡ã®å•é¡Œ
                    </button>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="hostStopBtn"
                            class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 rounded-lg text-xs">
                            â¸ ä¸­æ–­
                        </button>
                        <button id="hostFullResetBtn"
                            class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-3 rounded-lg text-xs">
                            ğŸ”„ å…¨ãƒªã‚»ãƒƒãƒˆ
                        </button>
                    </div>
                    <button id="hostSongResetBtn"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg text-xs">
                        ğŸµ æ›²ã ã‘ãƒªã‚»ãƒƒãƒˆï¼ˆã‚¹ã‚³ã‚¢ç¶­æŒï¼‰
                    </button>
                    <button id="hostDisbandBtn"
                        class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg text-xs mt-2">
                        ğŸšª éƒ¨å±‹ã‚’è§£æ•£ã—ã¦ãƒ­ãƒ“ãƒ¼ã¸
                    </button>
                </div>
                <div class="mt-3 text-xs text-gray-400 text-center">
                    ç¾åœ¨: ç¬¬<span id="hostQCount">0</span>å•
                </div>

                <!-- â˜…â˜…â˜… è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ â˜…â˜…â˜… -->
                <div id="settingsSection" class="mt-4 pt-4 border-t border-yellow-500">
                    <h4 class="text-sm font-bold text-yellow-400 mb-3 text-center cursor-pointer"
                        onclick="toggleSettingsPanel()">
                        âš™ï¸ è¨­å®š <span id="settingsToggleIcon">â–¼</span>
                    </h4>
                    <div id="settingsPanel" class="space-y-3 text-xs">
                        <!-- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆé¸æŠ -->
                        <div>
                            <label class="block text-gray-400 mb-1">ğŸµ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</label>
                            <div id="playlistCheckboxes"
                                class="bg-indigo-950 rounded p-2 max-h-28 overflow-y-auto space-y-1">
                                <!-- å‹•çš„ã«è¿½åŠ  -->
                            </div>
                        </div>

                        <!-- å•é¡Œæ•° -->
                        <div>
                            <label class="block text-gray-400 mb-1">ğŸ“ å•é¡Œæ•°</label>
                            <select id="settingMaxQuestions" onchange="saveRoomSettings()"
                                class="w-full bg-indigo-950 border border-indigo-600 rounded p-2 text-white">
                                <option value="5">5å•</option>
                                <option value="10">10å•</option>
                                <option value="15">15å•</option>
                                <option value="20">20å•</option>
                                <option value="30">30å•</option>
                                <option value="50">50å•</option>
                            </select>
                        </div>

                        <!-- å¾—ç‚¹è¨­å®š -->
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-gray-400 mb-1">âœ… æ­£è§£æ™‚</label>
                                <select id="settingCorrectPoints" onchange="saveRoomSettings()"
                                    class="w-full bg-indigo-950 border border-indigo-600 rounded p-1.5 text-white">
                                    <option value="0">0pt</option>
                                    <option value="1">+1pt</option>
                                    <option value="2">+2pt</option>
                                    <option value="3">+3pt</option>
                                    <option value="5">+5pt</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-400 mb-1">âŒ èª¤ç­”æ™‚</label>
                                <select id="settingWrongPoints" onchange="saveRoomSettings()"
                                    class="w-full bg-indigo-950 border border-indigo-600 rounded p-1.5 text-white">
                                    <option value="0">0pt</option>
                                    <option value="-1">-1pt</option>
                                    <option value="-2">-2pt</option>
                                    <option value="-3">-3pt</option>
                                </select>
                            </div>
                        </div>

                        <!-- æ™‚é–“è¨­å®š -->
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-gray-400 mb-1">ğŸµ æ›²å†ç”Ÿ</label>
                                <select id="settingPlayDuration" onchange="saveRoomSettings()"
                                    class="w-full bg-indigo-950 border border-indigo-600 rounded p-1.5 text-white">
                                    <option value="15">15ç§’</option>
                                    <option value="20">20ç§’</option>
                                    <option value="30">30ç§’</option>
                                    <option value="45">45ç§’</option>
                                    <option value="60">60ç§’</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-400 mb-1">â± å…¥åŠ›æ™‚é–“</label>
                                <select id="settingAnswerTime" onchange="saveRoomSettings()"
                                    class="w-full bg-indigo-950 border border-indigo-600 rounded p-1.5 text-white">
                                    <option value="10">10ç§’</option>
                                    <option value="15">15ç§’</option>
                                    <option value="20">20ç§’</option>
                                    <option value="30">30ç§’</option>
                                </select>
                            </div>
                        </div>

                        <!-- ãƒãƒ³ãƒ‡æˆ¦ãƒ¢ãƒ¼ãƒ‰ -->
                        <div class="flex items-center justify-between bg-indigo-950 p-2 rounded">
                            <label class="text-gray-300">ğŸ¯ ãƒãƒ³ãƒ‡æˆ¦</label>
                            <input type="checkbox" id="settingHandicapMode"
                                onchange="toggleHandicapSettings(); saveRoomSettings()"
                                class="w-5 h-5 accent-yellow-400">
                        </div>
                        <!-- ãƒãƒ³ãƒ‡æˆ¦è©³ç´°è¨­å®šï¼ˆãƒãƒ³ãƒ‡ãƒ¢ãƒ¼ãƒ‰ONæ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
                        <div id="handicapSettings"
                            class="hidden space-y-2 bg-yellow-900/30 p-2 rounded border border-yellow-600">
                            <p class="text-[10px] text-yellow-300 text-center font-bold">ãƒãƒ³ãƒ‡æˆ¦è©³ç´°è¨­å®š</p>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-gray-400 mb-1 text-[10px]">è¿½åŠ è€…ä»¥å¤–ã®æ­£è§£</label>
                                    <select id="settingHandicapBonus" onchange="saveRoomSettings()"
                                        class="w-full bg-indigo-950 border border-yellow-600 rounded p-1 text-white text-xs">
                                        <option value="1">+1pt</option>
                                        <option value="2">+2pt</option>
                                        <option value="3">+3pt</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-400 mb-1 text-[10px]">è¿½åŠ è€…ã®ä¸æ­£è§£</label>
                                    <select id="settingHandicapPenalty" onchange="saveRoomSettings()"
                                        class="w-full bg-indigo-950 border border-yellow-600 rounded p-1 text-white text-xs">
                                        <option value="0">0pt</option>
                                        <option value="-1">-1pt</option>
                                        <option value="-2">-2pt</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="block text-gray-400 mb-1 text-[10px]">â³ è¿½åŠ è€…ã®å›ç­”æ¨©é…å»¶</label>
                                <select id="settingHandicapDelay" onchange="saveRoomSettings()"
                                    class="w-full bg-indigo-950 border border-yellow-600 rounded p-1 text-white text-xs">
                                    <option value="0">ãªã—</option>
                                    <option value="0.5">0.5ç§’</option>
                                    <option value="1">1.0ç§’</option>
                                    <option value="1.5">1.5ç§’</option>
                                    <option value="2">2.0ç§’</option>
                                    <option value="2.5">2.5ç§’</option>
                                    <option value="3">3.0ç§’</option>
                                    <option value="3.5">3.5ç§’</option>
                                    <option value="4">4.0ç§’</option>
                                    <option value="4.5">4.5ç§’</option>
                                    <option value="5">5.0ç§’</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button onclick="document.getElementById('memberListPanel').classList.toggle('-translate-x-full')"
            class="md:hidden absolute top-4 left-4 z-30 bg-indigo-600 p-2 rounded text-xs opacity-50 hover:opacity-100 shadow-md">ğŸ‘¥</button>

        <!-- Game Screen -->
        <div id="gameScreen"
            class="relative flex-grow h-full flex flex-col items-center justify-center p-4 pb-safe overflow-hidden w-full">

            <!-- Compact Scoreboard (always visible) -->
            <div id="compactScoreboard"
                class="absolute top-2 right-2 z-30 bg-indigo-800/90 backdrop-blur-sm rounded-lg p-2 text-xs max-w-[150px] border border-indigo-600 shadow-lg">
                <div class="text-pink-300 font-bold text-center mb-1 border-b border-indigo-600 pb-1">ğŸ† ã‚¹ã‚³ã‚¢</div>
                <ul id="compactScoreList" class="space-y-0.5 max-h-32 overflow-y-auto">
                    <!-- Dynamically populated -->
                </ul>
            </div>

            <div id="timerContainer" class="absolute top-0 left-0 w-full h-2 bg-gray-800 z-10 hidden">
                <div id="timerBar" class="h-full w-full transition-all duration-linear"></div>
            </div>

            <div
                class="bg-indigo-950 p-6 rounded-3xl shadow-2xl border-4 border-pink-500 w-full max-w-lg text-center relative overflow-hidden flex flex-col items-center z-20">
                <div id="statusDisplay" class="text-xl font-bold text-gray-400 mb-4 animate-pulse">Wait...</div>
                <div id="messageBox"
                    class="text-2xl font-bold mb-6 text-white min-h-[40px] drop-shadow-md break-words w-full"></div>

                <div id="buzzerStatus"
                    class="hidden mb-4 p-4 bg-yellow-400 text-black font-bold rounded-xl animate-bounce w-full">
                    ğŸš¨ <span id="buzzerName"></span> ãŒå›ç­”æ¨©ã‚’ç²å¾—ï¼
                    <div class="text-sm font-normal mt-1">æ®‹ã‚Š <span id="answerTimer">15</span>ç§’</div>
                </div>

                <div id="answerArea" class="hidden mb-4 w-full">
                    <input type="text" id="answerInput"
                        class="w-full p-3 rounded-xl text-black font-bold text-center text-lg mb-2"
                        placeholder="æ›²åã‚’å…¥åŠ›..." autocomplete="off">
                    <button onclick="submitAnswer()"
                        class="w-full bg-pink-500 hover:bg-pink-600 py-3 rounded-xl font-bold text-white shadow-lg touch-manipulation">å›ç­”ã™ã‚‹
                        ğŸ¤</button>
                </div>

                <button id="buzzBtn" onclick="buzz()"
                    class="w-32 h-32 md:w-48 md:h-48 rounded-full bg-gradient-to-br from-red-500 to-pink-600 shadow-[0_10px_20px_rgba(0,0,0,0.5)] border-4 md:border-8 border-white text-2xl md:text-3xl font-black transform transition active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed touch-manipulation flex items-center justify-center shrink-0">PUSH</button>

                <!-- æŠ¼ã—ãŸç§’æ•°è¡¨ç¤º -->
                <div id="myBuzzTime" class="hidden mt-4 text-center">
                    <div class="text-sm text-gray-400">ã‚ãªãŸã®æŠ¼ã—ãŸæ™‚é–“</div>
                    <div id="myBuzzTimeValue" class="text-2xl font-bold text-yellow-400">0.00ç§’</div>
                </div>

                <!-- ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ï¼ˆã‚½ãƒ­ãƒ¢ãƒ¼ãƒ‰ã®resultçŠ¶æ…‹ã§è¡¨ç¤ºï¼‰ -->
                <button id="skipWaitBtn" onclick="skipWait()"
                    class="hidden mt-4 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg touch-manipulation">
                    â­ æ¬¡ã¸ã‚¹ã‚­ãƒƒãƒ—
                </button>
            </div>

            <div id="rankingOverlay"
                class="hidden absolute inset-0 bg-indigo-900 z-[60] flex flex-col items-center justify-start p-6 overflow-y-auto">
                <h1 class="text-4xl font-bold text-yellow-400 mb-6">ğŸ† çµæœç™ºè¡¨ ğŸ†</h1>
                <ul id="rankingList" class="w-full max-w-md space-y-3 mb-6"></ul>

                <h2
                    class="text-2xl font-bold text-pink-300 mb-4 border-t border-pink-500 pt-4 w-full max-w-md text-center">
                    ğŸ“‹ å•é¡Œå±¥æ­´</h2>
                <div id="historyList" class="w-full max-w-md space-y-2 mb-6"></div>

                <!-- é«˜é€Ÿå›ç­”ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
                <div id="speedRankingArea" class="w-full max-w-md mb-6 border-t border-yellow-500 pt-4"></div>

                <div id="replayArea" class="mt-4"></div>
                <a href="index.html" class="mt-4 text-white underline block text-center">ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</a>
            </div>
        </div>
    </div>

    <!-- Hidden Player - å®Œå…¨ã«éè¡¨ç¤ºã§æ›²æƒ…å ±ãŒè¦‹ãˆãªã„ã‚ˆã†ã«ã™ã‚‹ -->
    <div id="playerContainer"
        style="position: fixed; top: -9999px; left: -9999px; width: 1px; height: 1px; overflow: hidden; opacity: 0; visibility: hidden; pointer-events: none; z-index: -9999;">
        <div id="player" style="width: 1px; height: 1px;"></div>
    </div>

    <!-- Toast -->
    <div id="toast"
        class="fixed top-20 left-0 right-0 z-[70] flex justify-center pointer-events-none opacity-0 transition-opacity duration-500">
        <div id="toastMsg"
            class="bg-blue-600 text-white px-8 py-4 rounded-full shadow-2xl text-2xl font-bold border-4 border-white">
        </div>
    </div>

    <!-- Error Overlay -->
    <div id="errorOverlay"
        class="hidden absolute inset-0 bg-black z-[80] flex flex-col items-center justify-center text-red-500">
        <h1 class="text-2xl font-bold">ã‚¨ãƒ©ãƒ¼</h1>
        <p id="errorText">æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ</p>
        <a href="index.html" class="mt-4 text-white underline">æˆ»ã‚‹</a>
    </div>

    <div id="debugInfo"
        class="fixed bottom-0 right-0 bg-black/50 text-white text-[10px] p-1 z-[100] pointer-events-none font-mono">
        Init...</div>

    <script>
        const params = new URLSearchParams(window.location.search);
        // Ensure roomId is uppercase
        const roomId = (params.get('room') || '').toUpperCase();
        const currentUser = params.get('user');

        if (!roomId || !currentUser) window.location.href = 'index.html';
        document.getElementById('roomIdDisp').innerText = roomId;

        let player;
        let currentStatus = 'init';
        let currentSongId = null;
        let currentSongData = null;
        let currentSongAddedBy = null;
        let buzzerUserId = null;
        let playlist = {};
        let wrongAnswers = {};
        let isReady = false;
        let buzzTimeout;
        let currentStartTime = 0;
        let wrongAnswerRecoveryTimer = null;
        let currentHostName = null;
        let handicapMode = false;
        let serverTimeOffset = 0; // Difference between server and client time
        let myLastBuzzTime = null; // â˜… è‡ªåˆ†ãŒæŠ¼ã—ãŸç§’æ•°ã‚’ä¸€æ™‚ä¿å­˜ â˜…
        // â˜…â˜…â˜… è¨­å®šå¤‰æ•° â˜…â˜…â˜…
        let currentPlayDuration = 30; // æ›²å†ç”Ÿæ™‚é–“ï¼ˆç§’ï¼‰
        let currentAnswerTime = 15;   // å›ç­”å…¥åŠ›æ™‚é–“ï¼ˆç§’ï¼‰


        window.onYouTubeIframeAPIReady = function () {
            player = new YT.Player('player', {
                height: '1',
                width: '1',
                videoId: '',
                playerVars: {
                    'playsinline': 1,
                    'controls': 0,
                    'disablekb': 1,
                    'origin': window.location.origin,
                    'modestbranding': 1,  // YouTubeãƒ­ã‚´ã‚’æœ€å°åŒ–
                    'rel': 0,             // é–¢é€£å‹•ç”»ã‚’éè¡¨ç¤º
                    'showinfo': 0,        // å‹•ç”»æƒ…å ±ã‚’éè¡¨ç¤ºï¼ˆæ—§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã ãŒå¿µã®ãŸã‚ï¼‰
                    'iv_load_policy': 3,  // ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
                    'fs': 0               // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                },
                events: { 'onReady': onPlayerReady, 'onError': onPlayerError, 'onStateChange': onPlayerStateChange }
            });
        };

        // â˜…â˜…â˜… MediaSession APIã§ã‚¹ãƒãƒ›ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã«è¡¨ç¤ºã•ã‚Œã‚‹æƒ…å ±ã‚’ãƒ€ãƒŸãƒ¼ã«ã™ã‚‹ â˜…â˜…â˜…
        // ãƒ€ãƒŸãƒ¼ã®Audioè¦ç´ ã‚’ä½¿ã£ã¦MediaSessionã‚’å¥ªå–ã™ã‚‹
        let dummyAudio = null;

        function createDummyAudio() {
            if (!dummyAudio) {
                // ç„¡éŸ³ã®Base64ãƒ‡ãƒ¼ã‚¿ï¼ˆ1ç§’é–“ã®ç„¡éŸ³MP3ï¼‰
                const silentAudioBase64 = 'data:audio/mp3;base64,//uQxAAAAAANIAAAAAExBTUUzLjEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV';
                dummyAudio = new Audio(silentAudioBase64);
                dummyAudio.loop = true;
                dummyAudio.volume = 0.01; // ã»ã¼ç„¡éŸ³
            }
            return dummyAudio;
        }

        function setDummyMediaSession() {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: 'ğŸµ ã‚¤ãƒ³ãƒˆãƒ­ã‚¯ã‚¤ã‚º',
                    artist: 'ä¿ºé”ã®ã‚¤ãƒ³ãƒˆãƒ­ã‚¯ã‚¤ã‚ºï¼',
                    album: 'å•é¡Œå†ç”Ÿä¸­...',
                    artwork: [
                        { src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%234F46E5" width="100" height="100"/><text x="50" y="60" font-size="40" text-anchor="middle" fill="white">ğŸµ</text></svg>', sizes: '96x96', type: 'image/svg+xml' }
                    ]
                });
                // ãƒ¡ãƒ‡ã‚£ã‚¢ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                navigator.mediaSession.setActionHandler('play', () => { });
                navigator.mediaSession.setActionHandler('pause', () => { });
                navigator.mediaSession.setActionHandler('seekbackward', () => { });
                navigator.mediaSession.setActionHandler('seekforward', () => { });
                navigator.mediaSession.setActionHandler('previoustrack', () => { });
                navigator.mediaSession.setActionHandler('nexttrack', () => { });
            }
        }

        // ãƒ€ãƒŸãƒ¼Audioã‚’å†ç”Ÿã—ã¦MediaSessionã‚’å„ªå…ˆçš„ã«å–å¾—
        function startDummyAudioForMediaSession() {
            const audio = createDummyAudio();
            audio.play().then(() => {
                setDummyMediaSession();
            }).catch(() => {
                // è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ç„¡è¦–
            });
        }

        // å®šæœŸçš„ã«MediaSessionã‚’ãƒ€ãƒŸãƒ¼æƒ…å ±ã§ä¸Šæ›¸ãï¼ˆYouTubeã®ä¸Šæ›¸ãã«å¯¾æŠ—ï¼‰
        setInterval(() => {
            if (currentStatus === 'playing' || currentStatus === 'buzzed') {
                setDummyMediaSession();
            }
        }, 500);

        // Track last sync time to avoid repeated seeks
        let lastSyncStartTime = 0;

        function onPlayerStateChange(event) {
            // When video starts playing (state 1), re-sync to correct position
            if (event.data === YT.PlayerState.PLAYING && currentStatus === 'playing' && window.lastStartTime) {
                const serverStartTime = window.lastStartTime;
                const correctedNow = Date.now() + serverTimeOffset;
                const expectedElapsed = (correctedNow - serverStartTime) / 1000;
                const actualPosition = player.getCurrentTime ? player.getCurrentTime() : 0;
                const drift = Math.abs(expectedElapsed - actualPosition);

                // If drift is more than 1 second, re-seek
                if (drift > 1 && serverStartTime !== lastSyncStartTime) {
                    console.log(`Re-sync: Expected=${expectedElapsed.toFixed(1)}s, Actual=${actualPosition.toFixed(1)}s, Drift=${drift.toFixed(1)}s`);
                    player.seekTo(expectedElapsed, true);
                    lastSyncStartTime = serverStartTime;
                }
            }
        }

        function onPlayerReady(event) {
            isReady = true;
            event.target.setVolume(100);
            // ã‚¹ãƒãƒ›ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã«æ›²æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œãªã„ã‚ˆã†ãƒ€ãƒŸãƒ¼æƒ…å ±ã‚’ã‚»ãƒƒãƒˆ
            setDummyMediaSession();
        }

        function onPlayerError(event) {
            console.error("Youtube Error", event.data);
            // Only show error if we're actually playing a game
            if (currentStatus === 'playing' && currentSongId) {
                showToast(`âš ï¸ å†ç”Ÿã‚¨ãƒ©ãƒ¼ (ã‚¹ã‚­ãƒƒãƒ—)`, 'error');
                if (isHost()) {
                    setTimeout(() => {
                        const song = playlist[currentSongId];
                        const qCount = window.currentQuestionCount || 0;
                        window.VibeQuiz.reportTimeUp(roomId, song ? song.titleMain : "???", song, qCount);
                    }, 2000);
                }
            }
        }

        // â˜…â˜…â˜… NEW: Unified host check function â˜…â˜…â˜…
        function isHost() {
            // â˜… LocalStorageãƒ™ãƒ¼ã‚¹ã§ãƒ›ã‚¹ãƒˆåˆ¤å®šï¼ˆåå‰ã ã‘ã§ã¯åˆ¤å®šã—ãªã„ï¼‰ â˜…
            return localStorage.getItem(`host_${roomId}`) === 'true';
        }

        function showToast(msg, type = 'info') {
            const t = document.getElementById('toast');
            const tm = document.getElementById('toastMsg');
            tm.textContent = msg;
            let bgClass = 'bg-blue-600';
            if (type === 'success') bgClass = 'bg-green-600';
            if (type === 'error') bgClass = 'bg-red-600';
            tm.className = `px-8 py-4 rounded-full shadow-xl text-xl font-bold text-white border-4 border-white ${bgClass}`;
            t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 3000);
        }

        let isSpectator = false;  // â˜… è¦³æˆ¦è€…ãƒ•ãƒ©ã‚° â˜…

        async function init() {
            const overlay = document.getElementById('startOverlay');
            overlay.onclick = async () => {
                // â˜… ãƒ€ãƒŸãƒ¼Audioã‚’å…ˆã«å†ç”Ÿã—ã¦MediaSessionã‚’å–å¾—
                startDummyAudioForMediaSession();

                if (player && player.playVideo) {
                    player.unMute();
                    player.setVolume(100);
                    player.playVideo();
                    setTimeout(() => player.pauseVideo(), 500);
                }
                overlay.classList.add('hidden');

                try {
                    const result = await window.VibeQuiz.joinRoom(roomId, currentUser);

                    // â˜… è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰ã®åˆ¤å®š â˜…
                    if (result && result.isSpectator) {
                        isSpectator = true;
                        document.getElementById('buzzBtn').classList.add('hidden');
                        document.getElementById('myBuzzTime').classList.add('hidden');
                        showToast("è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰ã§å‚åŠ ã—ã¾ã—ãŸ", 'info');
                    }

                    startSync();
                } catch (e) {
                    document.getElementById('errorOverlay').classList.remove('hidden');
                    document.getElementById('errorText').innerText = e.message;
                }
            };
        }

        function startSync() {
            const db = window.VibeQuiz.db;
            const roomRef = db.ref(`rooms/${roomId}`);

            // Get server time offset for sync
            db.ref('.info/serverTimeOffset').once('value', snap => {
                serverTimeOffset = snap.val() || 0;
                console.log('Server time offset:', serverTimeOffset, 'ms');
            });

            roomRef.on('value', async snap => {
                const data = snap.val();
                // éƒ¨å±‹ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆã¯ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹
                if (!data) {
                    alert("éƒ¨å±‹ãŒè§£æ•£ã•ã‚Œã¾ã—ãŸã€‚ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚Šã¾ã™ã€‚");
                    window.location.href = 'index.html';
                    return;
                }

                // â˜…â˜…â˜… Store hostName from Firebase â˜…â˜…â˜…
                currentHostName = data.hostName || null;

                const settings = data.settings || {};
                handicapMode = settings.handicapMode || false;
                // â˜… è¨­å®šã‚’å¤‰æ•°ã«ä¿å­˜ â˜…
                currentPlayDuration = parseInt(settings.playDuration) || 30;
                currentAnswerTime = parseInt(settings.answerTime) || 15;

                // Support both new playlistIds and legacy playlistId
                let playlistIds = settings.playlistIds || [settings.playlistId || 'global'];
                if (!Array.isArray(playlistIds)) playlistIds = [playlistIds];

                if (Object.keys(playlist).length === 0 && !window.isFetchingPlaylist) {
                    window.isFetchingPlaylist = true;
                    try {
                        // Check if yaminabe is included
                        if (playlistIds.includes('yaminabe')) {
                            const globalSnap = await db.ref('playlist').once('value');
                            playlist = { ...(globalSnap.val() || {}) };
                            const allSnap = await db.ref('playlists').once('value');
                            const allData = allSnap.val() || {};
                            Object.values(allData).forEach(pl => {
                                if (pl.songs) playlist = { ...playlist, ...pl.songs };
                            });
                        } else {
                            // Fetch from selected playlists
                            for (const plId of playlistIds) {
                                if (plId === 'global') {
                                    const snap = await db.ref('playlist').once('value');
                                    playlist = { ...playlist, ...(snap.val() || {}) };
                                } else {
                                    const snap = await db.ref(`playlists/${plId}/songs`).once('value');
                                    playlist = { ...playlist, ...(snap.val() || {}) };
                                }
                            }
                        }
                    } catch (e) { console.error("Pl Fetch Error", e); }
                    window.isFetchingPlaylist = false;
                }

                const list = document.getElementById('participantsListHost');
                list.innerHTML = '';
                if (data.users) Object.entries(data.users).forEach(([uid, u]) => {
                    const li = document.createElement('li');
                    li.className = "p-2 bg-indigo-700 rounded text-sm font-bold text-white border border-indigo-500 shadow-sm flex justify-between items-center";
                    // ãƒ›ã‚¹ãƒˆè‡ªèº«ã¯ã‚­ãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ãªã„
                    if (isHost() && u.name !== currentUser) {
                        li.innerHTML = `
                            <span>${u.name} (${u.score || 0}pt)</span>
                            <button onclick="kickUser('${uid}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">âœ–</button>
                        `;
                    } else {
                        // â˜… UUIDãƒ™ãƒ¼ã‚¹ã§ãƒ›ã‚¹ãƒˆåˆ¤å®šï¼ˆåŒåãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾ç­–ï¼‰â˜…
                        const hostUUID = data.hostUUID || '';
                        const hostBadge = u.uuid === hostUUID ? ' ğŸ‘‘' : '';
                        li.textContent = `${u.name}${hostBadge} (${u.score || 0}pt)`;
                    }
                    list.appendChild(li);
                });

                // â˜…â˜…â˜… è¦³æˆ¦è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–° â˜…â˜…â˜…
                const spectatorSection = document.getElementById('spectatorSection');
                const spectatorsList = document.getElementById('spectatorsList');
                spectatorsList.innerHTML = '';
                if (data.spectators && Object.keys(data.spectators).length > 0) {
                    spectatorSection.classList.remove('hidden');
                    Object.values(data.spectators).forEach(s => {
                        const li = document.createElement('li');
                        li.textContent = s.name;
                        spectatorsList.appendChild(li);
                    });
                } else {
                    spectatorSection.classList.add('hidden');
                }

                // Update compact scoreboard with tie handling
                const compactList = document.getElementById('compactScoreList');
                compactList.innerHTML = '';
                if (data.users) {
                    const sortedUsers = Object.values(data.users).sort((a, b) => (b.score || 0) - (a.score || 0));
                    let currentRank = 1;
                    let prevScore = null;
                    sortedUsers.forEach((u, i) => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center py-0.5';
                        const score = u.score || 0;
                        // åŒç‡é †ä½ã®è¨ˆç®—: ã‚¹ã‚³ã‚¢ãŒå‰ã¨åŒã˜ãªã‚‰é †ä½ã‚’ç¶­æŒ
                        if (prevScore !== null && score !== prevScore) {
                            currentRank = i + 1;
                        }
                        prevScore = score;
                        const medal = currentRank === 1 ? 'ğŸ¥‡' : (currentRank === 2 ? 'ğŸ¥ˆ' : (currentRank === 3 ? 'ğŸ¥‰' : ''));
                        li.innerHTML = `<span class="truncate">${medal}${u.name}</span><span class="font-bold text-yellow-400">${score}</span>`;
                        compactList.appendChild(li);
                    });
                }

                // Show/hide host control panel
                const hostPanel = document.getElementById('hostControlPanel');
                const settingsSection = document.getElementById('settingsSection');
                if (isHost()) {
                    hostPanel.classList.remove('hidden');
                    document.getElementById('hostQCount').textContent = data.questionCount || 0;
                    // è¨­å®šã‚’UIã«åæ˜ 
                    loadSettingsToUI(settings);
                } else {
                    hostPanel.classList.add('hidden');
                    // éãƒ›ã‚¹ãƒˆã«ã¯è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
                    if (settingsSection) settingsSection.classList.add('hidden');
                }

                currentStatus = data.status || 'waiting';
                buzzerUserId = data.buzzerUserId || '';  // â˜… UUIDã§åˆ¤å®š â˜…
                currentSongId = data.currentSongId;
                currentSongAddedBy = data.currentSongAddedBy || null;
                wrongAnswers = data.wrongAnswers || {};
                currentStartTime = data.playStartTime || data.startTime || 0;

                const qCount = data.questionCount || 0;
                window.currentQuestionCount = qCount;
                const statusTxt = qCount > 0 ? `Q${qCount}: ${currentStatus.toUpperCase()}` : currentStatus.toUpperCase();
                document.getElementById('statusDisplay').innerText = statusTxt;
                document.getElementById('headerStatus').innerText = statusTxt;

                if (data.message && data.message.timestamp > Date.now() - 5000) {
                    showToast(data.message.text, data.message.type);
                }

                const msgText = data.message ? data.message.text.replace(/\n/g, '<br>') : '';
                document.getElementById('messageBox').innerHTML = msgText;

                syncUI(currentStatus, data);
            });
        }

        function syncUI(status, data) {
            const els = {
                buzzer: document.getElementById('buzzBtn'),
                ansArea: document.getElementById('answerArea'),
                buzzerStatus: document.getElementById('buzzerStatus'),
                timerBar: document.getElementById('timerBar'),
                timerContainer: document.getElementById('timerContainer'),
                rank: document.getElementById('rankingOverlay')
            };

            els.ansArea.classList.add('hidden');

            if (status === 'waiting') {
                els.rank.classList.add('hidden');
                els.buzzer.classList.add('hidden');
                document.getElementById('statusDisplay').innerText = "WAITING - ãƒ›ã‚¹ãƒˆå¾…æ©Ÿä¸­";
                els.timerContainer.classList.add('hidden');
                els.buzzerStatus.classList.add('hidden');
                if (player && player.pauseVideo) player.pauseVideo();

                // â˜… waitingçŠ¶æ…‹ã§ã¯è¨­å®šãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º â˜…
                const settingsSection = document.getElementById('settingsSection');
                if (settingsSection && isHost()) {
                    settingsSection.classList.remove('hidden');
                }
            }
            else if (status === 'result') {
                els.rank.classList.add('hidden');
                els.buzzer.disabled = true;
                els.buzzer.classList.remove('hidden');
                els.timerContainer.classList.add('hidden');
                els.buzzerStatus.classList.add('hidden');
                if (player && player.pauseVideo) player.pauseVideo();

                // â˜… ã‚²ãƒ¼ãƒ ä¸­ï¼ˆresultå«ã‚€ï¼‰ã¯è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º â˜…
                document.getElementById('settingsSection').classList.add('hidden');

                // â˜… ã‚½ãƒ­ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼1äººï¼‰ã‹ã¤ãƒ›ã‚¹ãƒˆã®å ´åˆã®ã¿ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º â˜…
                const skipBtn = document.getElementById('skipWaitBtn');
                const userCount = data.users ? Object.keys(data.users).length : 0;
                const isSoloMode = userCount <= 1;
                if (skipBtn && isHost() && isSoloMode) {
                    skipBtn.classList.remove('hidden');
                } else if (skipBtn) {
                    skipBtn.classList.add('hidden');
                }

                // â˜… ãƒ›ã‚¹ãƒˆã®ã¿ãŒè‡ªå‹•é€²è¡Œã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®š â˜…
                if (isHost() && !window.resultAutoTimer) {
                    window.resultAutoTimer = setTimeout(async () => {
                        window.resultAutoTimer = null;
                        try {
                            await window.VibeQuiz.nextQuestion(roomId);
                        } catch (e) {
                            console.error('Auto next question error:', e);
                        }
                    }, 6000);
                }
            }
            else if (status === 'playing') {
                els.rank.classList.add('hidden');
                if (buzzTimeout) { clearTimeout(buzzTimeout); buzzTimeout = null; }

                // â˜… resultçŠ¶æ…‹ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢ â˜…
                if (window.resultAutoTimer) { clearTimeout(window.resultAutoTimer); window.resultAutoTimer = null; }

                els.buzzerStatus.classList.add('hidden');
                els.buzzer.classList.remove('hidden');

                // â˜… ç§’æ•°è¡¨ç¤ºã®ãƒªã‚»ãƒƒãƒˆã¯æ›²ãŒå¤‰ã‚ã£ãŸæ™‚ã®ã¿ â˜…
                // ï¼ˆèª¤ç­”å¾Œã®playingå¾©å¸°æ™‚ã¯ãƒªã‚»ãƒƒãƒˆã—ãªã„ï¼‰
                if (!data.buzzTimes) {
                    document.getElementById('myBuzzTime').classList.add('hidden');
                    myLastBuzzTime = null;
                }

                // â˜… ã‚²ãƒ¼ãƒ ä¸­ã¯è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º â˜…
                document.getElementById('settingsSection').classList.add('hidden');
                document.getElementById('skipWaitBtn').classList.add('hidden');

                els.timerContainer.classList.remove('hidden');

                // â˜… ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã‚’playStartTimeãƒ™ãƒ¼ã‚¹ã§è¨ˆç®—ï¼ˆèª¤ç­”å¾Œã‚‚ãƒªã‚»ãƒƒãƒˆã—ãªã„ï¼‰â˜…
                const serverNow = Date.now() + serverTimeOffset;
                let playStartTime = data.playStartTime || serverNow;

                // â˜… playStartTimeãŒæœªæ¥ã¾ãŸã¯å¤ã™ãã‚‹å ´åˆã¯ç¾åœ¨æ™‚åˆ»ã‚’ä½¿ç”¨ â˜…
                if (playStartTime > serverNow + 1000) {
                    playStartTime = serverNow;
                }
                const elapsed = Math.max(0, (serverNow - playStartTime) / 1000);
                const remaining = Math.max(0, currentPlayDuration - elapsed);
                const percentage = (remaining / currentPlayDuration) * 100;

                requestAnimationFrame(() => {
                    const timerBar = document.getElementById('timerBar');
                    timerBar.className = "h-full w-full bg-yellow-400";
                    timerBar.style.transition = 'none';
                    timerBar.style.width = percentage + '%';
                    setTimeout(() => {
                        timerBar.style.transition = `width ${remaining}s linear`;
                        timerBar.style.width = '0%';
                    }, 50);
                });

                // â˜… UUIDãƒ™ãƒ¼ã‚¹ã§wrongAnswersãƒã‚§ãƒƒã‚¯ â˜…
                const myUserId = localStorage.getItem('vibeQuizUserId') || '';
                if (wrongAnswers && wrongAnswers[myUserId]) {
                    els.buzzer.disabled = true;
                    els.buzzer.style.opacity = "0.5";
                    els.buzzer.innerText = "âŒ";

                    // â˜…â˜…â˜… Use isHost() function â˜…â˜…â˜…
                    if (isHost() && !wrongAnswerRecoveryTimer) {
                        wrongAnswerRecoveryTimer = setTimeout(() => {
                            if (currentStatus === 'playing') {
                                window.VibeQuiz.clearWrongAnswers(roomId);
                                showToast("å›ç­”æ¨©ãŒå¾©æ´»ã—ã¾ã—ãŸï¼", 'info');
                            }
                            wrongAnswerRecoveryTimer = null;
                        }, 10000);
                    }
                } else {
                    // â˜… ã¾ã ä»Šå›ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã„ãªã„å ´åˆã®ã¿PUSHè¡¨ç¤º â˜…
                    if (myLastBuzzTime === null) {
                        els.buzzer.disabled = false;
                        els.buzzer.style.opacity = "1";
                        els.buzzer.innerText = "PUSH";
                        els.buzzer.onclick = () => window.buzz();
                    }
                    // â˜… æ—¢ã«æŠ¼ã—ã¦ã„ãŸå ´åˆã¯ãã®ã¾ã¾ç¶­æŒï¼ˆUIå¤‰æ›´ã—ãªã„ï¼‰â˜…
                    if (wrongAnswerRecoveryTimer) { clearTimeout(wrongAnswerRecoveryTimer); wrongAnswerRecoveryTimer = null; }
                }

                if (currentSongId && playlist[currentSongId]) {
                    currentSongData = playlist[currentSongId];
                    if (player && player.loadVideoById) {
                        const url = player.getVideoUrl ? player.getVideoUrl() : '';
                        const videoId = currentSongData.youtubeId;
                        const seekTo = data.seekTo || 0;  // â˜… å·»ãæˆ»ã—ä½ç½® â˜…

                        if (!url || !url.includes(videoId)) {
                            // æ–°ã—ã„æ›²ã‚’ãƒ­ãƒ¼ãƒ‰
                            player.loadVideoById({
                                videoId: videoId,
                                startSeconds: seekTo
                            });
                            player.setVolume(100);
                            console.log(`Playing: ${videoId} from ${seekTo}s`);
                        } else {
                            // â˜… åŒã˜æ›²ãªã‚‰seekã—ã¦å†ç”Ÿ â˜…
                            if (seekTo > 0) {
                                player.seekTo(seekTo, true);
                            }
                            if (player.getPlayerState() !== 1) player.playVideo();
                        }
                    }
                }
            }
            else if (status === 'buzzed') {
                if (player && player.pauseVideo) player.pauseVideo();

                const name = data.buzzerUser || '???';
                document.getElementById('buzzerName').innerText = name;
                els.buzzerStatus.classList.remove('hidden');

                const timerBar = document.getElementById('timerBar');
                timerBar.className = "h-full w-full bg-red-500";
                requestAnimationFrame(() => {
                    timerBar.style.transition = 'none';
                    timerBar.style.width = '100%';
                    setTimeout(() => {
                        timerBar.style.transition = `width ${currentAnswerTime}s linear`;
                        timerBar.style.width = '0%';
                    }, 50);
                });

                // Countdown display
                const timerSpan = document.getElementById('answerTimer');
                let countdownVal = currentAnswerTime;
                timerSpan.textContent = countdownVal;
                timerSpan.className = 'text-black';

                if (window.countdownInterval) clearInterval(window.countdownInterval);
                window.countdownInterval = setInterval(() => {
                    countdownVal--;
                    if (countdownVal >= 0) {
                        timerSpan.textContent = countdownVal;
                        if (countdownVal <= 5) {
                            timerSpan.className = 'text-red-600 font-extrabold text-xl animate-pulse';
                        }
                    } else {
                        clearInterval(window.countdownInterval);
                    }
                }, 1000);

                // â˜… UUIDãƒ™ãƒ¼ã‚¹ã§å›ç­”æ¨©åˆ¤å®šï¼ˆåŒåãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾ç­–ï¼‰â˜…
                const myUserId = localStorage.getItem('vibeQuizUserId') || '';
                const currentBuzzerUserId = data.buzzerUserId || '';  // â˜… ç¾åœ¨ã®buzzerUserIdã‚’å–å¾— â˜…

                console.log('Buzz check:', {
                    myUserId,
                    currentBuzzerUserId,
                    name,
                    match: currentBuzzerUserId === myUserId,
                    dataKeys: Object.keys(data)
                });

                if (currentBuzzerUserId && currentBuzzerUserId === myUserId) {
                    els.ansArea.classList.remove('hidden');
                    els.buzzer.classList.add('hidden');  // å›ç­”æ¨©ç²å¾—è€…ã¯ãƒœã‚¿ãƒ³éè¡¨ç¤º
                    setTimeout(() => document.getElementById('answerInput').focus(), 100);

                    if (buzzTimeout) clearTimeout(buzzTimeout);
                    const capturedBuzzerUserId = currentBuzzerUserId;  // â˜… ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã§ä¿æŒ â˜…
                    buzzTimeout = setTimeout(async () => {
                        if (currentStatus === 'buzzed' && capturedBuzzerUserId === myUserId) {
                            const time = player && player.getCurrentTime ? player.getCurrentTime() : 0;
                            try { await window.VibeQuiz.reportLoss(roomId, currentUser, time); } catch (e) { console.error(e); }
                        }
                    }, currentAnswerTime * 1000);
                } else {
                    // â˜… ä»–ã®äººãŒå›ç­”æ¨©ã‚’å¾—ãŸå ´åˆ â˜…
                    // ãƒœã‚¿ãƒ³UIã¯å¤‰æ›´ã—ãªã„ï¼ˆæŠ¼ã—ãŸçŠ¶æ…‹ã‚’ç¶­æŒï¼‰

                    // â˜… ç§’æ•°è¡¨ç¤ºã®å¾©å…ƒã®ã¿è¡Œã† â˜…
                    if (myLastBuzzTime !== null) {
                        const myBuzzTimeEl = document.getElementById('myBuzzTime');
                        if (myBuzzTimeEl.classList.contains('hidden')) {
                            document.getElementById('myBuzzTimeValue').textContent = myLastBuzzTime.toFixed(2) + 'ç§’';
                            myBuzzTimeEl.classList.remove('hidden');
                        }
                    }
                }
            }
            else if (status === 'completed') {
                els.rank.classList.remove('hidden');
                els.buzzerStatus.classList.add('hidden');
                if (player && player.stopVideo) player.stopVideo();

                const users = Object.values(data.users || {});
                users.sort((a, b) => (b.score || 0) - (a.score || 0));
                const ul = document.getElementById('rankingList');
                ul.innerHTML = '';
                let currentRank = 1;
                let prevScore = null;
                users.forEach((u, i) => {
                    const li = document.createElement('li');
                    li.className = "bg-indigo-800 p-4 rounded flex justify-between items-center text-xl font-bold border-2 border-indigo-600";
                    const score = u.score || 0;
                    // åŒç‡é †ä½ã®è¨ˆç®—
                    if (prevScore !== null && score !== prevScore) {
                        currentRank = i + 1;
                    }
                    const isTied = prevScore !== null && score === prevScore;
                    prevScore = score;

                    const rankText = isTied ? `åŒç‡${currentRank}ä½` : `${currentRank}ä½`;
                    if (currentRank === 1) {
                        li.classList.add('border-yellow-400', 'text-yellow-400');
                        li.innerHTML = `ğŸ¥‡ ${isTied ? 'åŒç‡1ä½ ' : ''}${u.name} <span class="text-2xl">${score}pt</span>`;
                    } else if (currentRank === 2) {
                        li.innerHTML = `ğŸ¥ˆ ${rankText} ${u.name} <span>${score}pt</span>`;
                    } else if (currentRank === 3) {
                        li.innerHTML = `ğŸ¥‰ ${rankText} ${u.name} <span>${score}pt</span>`;
                    } else {
                        li.innerHTML = `${rankText} ${u.name} <span>${score}pt</span>`;
                    }
                    ul.appendChild(li);
                });

                // â˜…â˜…â˜… Display Question History with answer time â˜…â˜…â˜…
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';
                const history = data.history || {};
                const historyArray = Object.values(history).sort((a, b) => a.questionNum - b.questionNum);

                historyArray.forEach(h => {
                    const div = document.createElement('div');
                    div.className = "bg-indigo-800 p-3 rounded flex items-center space-x-3 border border-indigo-600";
                    const timeDisplay = h.answerTime !== null && h.answerTime !== undefined
                        ? `<span class="text-yellow-400 font-mono">${h.answerTime.toFixed(2)}ç§’</span>`
                        : '';
                    div.innerHTML = `
                        <img src="${h.thumbnail || ''}" class="w-12 h-7 object-cover rounded bg-black flex-shrink-0">
                        <div class="flex-grow min-w-0">
                            <div class="text-xs text-gray-400">Q${h.questionNum}</div>
                            <a href="https://www.youtube.com/watch?v=${h.youtubeId}" target="_blank" 
                               class="text-sm font-bold text-white hover:text-pink-400 hover:underline truncate block">
                                ${h.songTitle}
                            </a>
                        </div>
                        <div class="text-xs text-right flex-shrink-0 ${h.winner ? 'text-green-400' : 'text-gray-500'}">
                            ${h.winner ? 'ğŸ‰ ' + h.winner : 'æ™‚é–“åˆ‡ã‚Œ'}
                            ${timeDisplay ? '<br>' + timeDisplay : ''}
                        </div>
                    `;
                    historyList.appendChild(div);
                });

                // â˜…â˜…â˜… High Speed Answer Ranking â˜…â˜…â˜…
                const speedRankingArea = document.getElementById('speedRankingArea');
                if (speedRankingArea) {
                    speedRankingArea.innerHTML = '';

                    // Filter answers with valid time and sort by speed
                    const fastestAnswers = historyArray
                        .filter(h => h.winner && h.answerTime !== null && h.answerTime !== undefined)
                        .sort((a, b) => a.answerTime - b.answerTime)
                        .slice(0, 5); // Top 5

                    if (fastestAnswers.length > 0) {
                        const speedTitle = document.createElement('h2');
                        speedTitle.className = "text-xl font-bold text-yellow-400 mb-3 text-center";
                        speedTitle.innerHTML = "âš¡ é«˜é€Ÿå›ç­”ãƒ©ãƒ³ã‚­ãƒ³ã‚°";
                        speedRankingArea.appendChild(speedTitle);

                        fastestAnswers.forEach((h, i) => {
                            const div = document.createElement('div');
                            div.className = "bg-gradient-to-r from-yellow-900/50 to-indigo-800 p-2 rounded flex items-center space-x-2 border border-yellow-600/50 mb-1";
                            const medal = i === 0 ? 'ğŸ¥‡' : (i === 1 ? 'ğŸ¥ˆ' : (i === 2 ? 'ğŸ¥‰' : `${i + 1}.`));
                            div.innerHTML = `
                                <span class="text-lg">${medal}</span>
                                <span class="font-bold text-white">${h.winner}</span>
                                <span class="text-gray-400 text-xs truncate flex-grow">${h.songTitle}</span>
                                <span class="font-mono text-yellow-400 font-bold">${h.answerTime.toFixed(2)}ç§’</span>
                            `;
                            speedRankingArea.appendChild(div);
                        });
                    }
                }

                // â˜…â˜…â˜… Replay Button for Host, Wait Message for Others â˜…â˜…â˜…
                const replayArea = document.getElementById('replayArea');
                replayArea.innerHTML = '';
                if (isHost()) {
                    const replayBtn = document.createElement('button');
                    replayBtn.className = "bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition active:scale-95";
                    replayBtn.innerText = "ğŸ”„ ã‚‚ã†ä¸€åº¦éŠã¶";
                    replayBtn.onclick = async () => {
                        replayBtn.disabled = true;
                        replayBtn.innerText = "ãƒªã‚»ãƒƒãƒˆä¸­...";
                        await window.VibeQuiz.restartGame(roomId);
                    };
                    replayArea.appendChild(replayBtn);
                } else {
                    const waitMsg = document.createElement('div');
                    waitMsg.className = "text-gray-400 text-center p-4";
                    waitMsg.innerHTML = "â³ ãƒ›ã‚¹ãƒˆãŒãƒªã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...";
                    replayArea.appendChild(waitMsg);
                }
            }
        }

        setInterval(() => {
            if (player && player.getPlayerState) {
                const state = player.getPlayerState();
                const time = player.getCurrentTime ? player.getCurrentTime() : 0;
                document.getElementById('debugInfo').innerText = `St:${state} T:${time.toFixed(1)} PL:${Object.keys(playlist).length}`;
                if (state === 1 && time > currentPlayDuration) player.pauseVideo();
            }
        }, 500);

        // â˜…â˜…â˜… Use isHost() function â˜…â˜…â˜…
        setInterval(() => {
            if (isHost() && currentStatus === 'playing') {
                let isTimeUp = false;
                if (player && player.getCurrentTime && player.getCurrentTime() > currentPlayDuration + 0.5) isTimeUp = true;
                if (currentStartTime && Date.now() - currentStartTime > (currentPlayDuration * 1000) + 2000) isTimeUp = true;

                if (isTimeUp && !window.sentTimeUp) {
                    const song = playlist[currentSongId];
                    const qCount = window.currentQuestionCount || 0;
                    window.sentTimeUp = true;
                    window.VibeQuiz.reportTimeUp(roomId, song ? song.titleMain : "???", song, qCount);
                    setTimeout(() => window.sentTimeUp = false, 8000);
                }
            }
        }, 1000);

        window.submitAnswer = async function () {
            const val = document.getElementById('answerInput').value.trim();
            document.getElementById('answerInput').value = '';
            document.getElementById('answerArea').classList.add('hidden');
            document.getElementById('answerInput').blur();

            if (buzzTimeout) { clearTimeout(buzzTimeout); buzzTimeout = null; }

            if (!currentSongData) {
                showToast("æ›²ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼", 'error');
                await window.VibeQuiz.reportLoss(roomId, currentUser, 0);
                return;
            }

            const nVal = normalize(val);
            const mains = normalize(currentSongData.titleMain);

            // â˜… è¤‡æ•°åˆ¥åå¯¾å¿œï¼šæ”¹è¡Œã§åˆ†å‰²ã—ã¦å„åˆ¥åã¨ç…§åˆ â˜…
            const titleHiraRaw = currentSongData.titleHira || '';
            const aliases = titleHiraRaw.split(/[\n\r]+/).map(a => normalize(a)).filter(a => a);
            const isCorrect = nVal === mains || aliases.some(alias => nVal === alias);

            if (isCorrect) {
                // â˜… æ—¢ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹myLastBuzzTimeã‚’ä½¿ç”¨ï¼ˆæ™‚é–“ã®ã‚ºãƒ¬ã‚’é˜²ãï¼‰â˜…
                const answerTime = myLastBuzzTime !== null ? myLastBuzzTime : (player && player.getCurrentTime ? player.getCurrentTime() : 0);
                await window.VibeQuiz.reportWin(roomId, currentUser, currentSongId, currentSongData, answerTime);
            } else {
                const time = player && player.getCurrentTime ? player.getCurrentTime() : 0;
                await window.VibeQuiz.reportLoss(roomId, currentUser, time);
            }
        };

        window.buzz = () => {
            // â˜… UUIDãƒ™ãƒ¼ã‚¹ã§wrongAnswersãƒã‚§ãƒƒã‚¯ï¼ˆåŒåãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾ç­–ï¼‰â˜…
            const userId = localStorage.getItem('vibeQuizUserId') || '';

            // â˜… æ—¢ã«æŠ¼ã—ã¦ã„ãŸã‚‰ä½•ã‚‚ã—ãªã„ â˜…
            if (myLastBuzzTime !== null) return;
            if (wrongAnswers[userId]) return;

            // â˜… æ›²é–‹å§‹ã‹ã‚‰ã®çµŒéæ™‚é–“ã‚’è¨ˆç®—ï¼ˆã‚µãƒ¼ãƒãƒ¼æ™‚åˆ»åŒæœŸï¼‰â˜…
            const serverNow = Date.now() + serverTimeOffset;
            const buzzTime = Math.max(0, (serverNow - currentStartTime) / 1000);
            myLastBuzzTime = buzzTime;  // â˜… ä¸€æ™‚ä¿å­˜ â˜…

            // â˜… UIç¢ºå®šï¼ˆçŠ¶æ…‹å¤‰æ›´ã«ä¾å­˜ã—ãªã„ï¼‰â˜…
            document.getElementById('myBuzzTimeValue').textContent = buzzTime.toFixed(2) + 'ç§’';
            document.getElementById('myBuzzTime').classList.remove('hidden');
            const buzzerBtn = document.getElementById('buzzBtn');
            if (buzzerBtn) {
                buzzerBtn.disabled = true;
                buzzerBtn.innerText = "âœ“";
                buzzerBtn.style.opacity = "0.5";
            }

            // â˜… Firebaseã«é€ä¿¡ï¼ˆplayingã®å ´åˆã®ã¿ï¼‰â˜…
            if (currentStatus === 'playing') {
                window.VibeQuiz.buzz(roomId, currentUser, userId, buzzTime);
            }
        };
        window.forceAudio = () => { if (player) { player.unMute(); player.setVolume(100); player.playVideo(); } };

        // â˜… ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ï¼ˆresultçŠ¶æ…‹ã®å¾…æ©Ÿæ™‚é–“ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰â˜…
        window.skipWait = async () => {
            if (!isHost()) return;
            // â˜… ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢ â˜…
            if (window.resultAutoTimer) { clearTimeout(window.resultAutoTimer); window.resultAutoTimer = null; }
            try {
                await window.VibeQuiz.nextQuestion(roomId);
            } catch (e) {
                console.error('Skip wait error:', e);
            }
        };

        function normalize(s) {
            if (!s) return "";
            return s.trim().replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                .replace(/[\s\u3000!ï¼?ï¼Ÿã€ã€‚,\.\-~ï½]/g, "").toLowerCase();
        }

        // â˜…â˜…â˜… Host Control Functions â˜…â˜…â˜…
        window.kickUser = (uid) => {
            if (isHost()) {
                window.VibeQuiz.removeUser(roomId, uid);
            }
        };

        function setupHostControls() {
            document.getElementById('hostStartBtn').addEventListener('click', async () => {
                if (!isHost()) return;

                // â˜…â˜…â˜… 2äººä»¥ä¸Šåˆ¶é™ï¼ˆã‚½ãƒ­ãƒ¢ãƒ¼ãƒ‰ä»¥å¤–ï¼‰ â˜…â˜…â˜…
                const roomSnap = await window.VibeQuiz.db.ref(`rooms/${roomId}`).once('value');
                const roomData = roomSnap.val() || {};
                const soloMode = roomData.settings?.soloMode || false;
                const userCount = roomData.users ? Object.keys(roomData.users).length : 0;

                if (!soloMode && userCount < 2) {
                    showToast("2äººä»¥ä¸Šã§ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„", 'error');
                    return;
                }

                showToast("å•é¡Œæº–å‚™ä¸­...", 'info');
                await window.VibeQuiz.nextQuestion(roomId);
            });

            document.getElementById('hostStopBtn').addEventListener('click', () => {
                if (!isHost()) return;
                window.VibeQuiz.stopGame(roomId);
                showToast("ã‚²ãƒ¼ãƒ ã‚’ä¸­æ–­ã—ã¾ã—ãŸ", 'info');
            });

            document.getElementById('hostFullResetBtn').addEventListener('click', () => {
                if (!isHost()) return;
                if (confirm("å…¨ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚¹ã‚³ã‚¢ã¨é€²è¡ŒçŠ¶æ³ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ï¼‰")) {
                    window.VibeQuiz.restartGame(roomId);
                    showToast("å…¨ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ", 'info');
                }
            });

            document.getElementById('hostSongResetBtn').addEventListener('click', () => {
                if (!isHost()) return;
                if (confirm("æ›²ã®é€²è¡Œã ã‘ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚¹ã‚³ã‚¢ã¯ç¶­æŒã•ã‚Œã¾ã™ï¼‰")) {
                    window.VibeQuiz.resetGame(roomId);
                    showToast("æ›²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ", 'info');
                }
            });

            document.getElementById('hostDisbandBtn').addEventListener('click', async () => {
                if (!isHost()) return;
                if (confirm("éƒ¨å±‹ã‚’è§£æ•£ã—ã¾ã™ã‹ï¼Ÿ\nå…¨å“¡ãŒãƒ­ãƒ“ãƒ¼ã«æˆ»ã•ã‚Œã¾ã™ã€‚")) {
                    await window.VibeQuiz.db.ref(`rooms/${roomId}`).remove();
                    localStorage.removeItem(`host_${roomId}`);
                    window.location.href = 'index.html';
                }
            });
        }

        // Setup host controls after DOM is ready
        setupHostControls();

        // â˜…â˜…â˜… è¨­å®šé–¢é€£é–¢æ•° â˜…â˜…â˜…
        let settingsPanelOpen = true;

        function toggleSettingsPanel() {
            const panel = document.getElementById('settingsPanel');
            const icon = document.getElementById('settingsToggleIcon');
            settingsPanelOpen = !settingsPanelOpen;
            if (settingsPanelOpen) {
                panel.classList.remove('hidden');
                icon.textContent = 'â–¼';
            } else {
                panel.classList.add('hidden');
                icon.textContent = 'â–¶';
            }
        }

        // è¨­å®šã‚’UIã«åæ˜ 
        function loadSettingsToUI(settings) {
            if (!settings) return;

            document.getElementById('settingMaxQuestions').value = settings.maxQuestions || 10;
            document.getElementById('settingCorrectPoints').value = settings.correctPoints !== undefined ? settings.correctPoints : 1;
            document.getElementById('settingWrongPoints').value = settings.wrongPoints !== undefined ? settings.wrongPoints : 0;
            document.getElementById('settingPlayDuration').value = settings.playDuration || 30;
            document.getElementById('settingAnswerTime').value = settings.answerTime || 15;
            document.getElementById('settingHandicapMode').checked = settings.handicapMode || false;

            // ãƒãƒ³ãƒ‡æˆ¦è©³ç´°è¨­å®š
            document.getElementById('settingHandicapBonus').value = settings.handicapBonus !== undefined ? settings.handicapBonus : 2;
            document.getElementById('settingHandicapPenalty').value = settings.handicapPenalty !== undefined ? settings.handicapPenalty : -1;
            document.getElementById('settingHandicapDelay').value = settings.handicapDelay !== undefined ? settings.handicapDelay : 0;
            toggleHandicapSettings();

            // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
            const playlistIds = settings.playlistIds || ['global'];
            document.querySelectorAll('#playlistCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = playlistIds.includes(cb.value);
            });
        }

        // ãƒãƒ³ãƒ‡æˆ¦è©³ç´°è¨­å®šã®è¡¨ç¤ºåˆ‡æ›¿
        function toggleHandicapSettings() {
            const isChecked = document.getElementById('settingHandicapMode').checked;
            const panel = document.getElementById('handicapSettings');
            if (isChecked) {
                panel.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä¸€è¦§ã‚’å‹•çš„ã«èª­ã¿è¾¼ã‚€
        async function loadPlaylistOptions() {
            const container = document.getElementById('playlistCheckboxes');
            container.innerHTML = `
                <label class="flex items-center text-xs cursor-pointer hover:bg-indigo-900 p-1 rounded">
                    <input type="checkbox" value="global" onchange="saveRoomSettings()" class="mr-2 w-3 h-3 accent-pink-500">
                    <span>Global (Default)</span>
                </label>
                <label class="flex items-center text-xs cursor-pointer hover:bg-indigo-900 p-1 rounded">
                    <input type="checkbox" value="yaminabe" onchange="saveRoomSettings()" class="mr-2 w-3 h-3 accent-pink-500">
                    <span>ğŸ² é—‡é‹ãƒ¢ãƒ¼ãƒ‰ (å…¨æ›²)</span>
                </label>
            `;

            try {
                const playlists = await window.VibeQuiz.getPlaylists();
                const myUserId = localStorage.getItem('vibeQuizUserId') || '';

                playlists.forEach(pl => {
                    // â˜… å€‹äººç”¨ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã¯è‡ªåˆ†ã®ã‚‚ã®ã ã‘è¡¨ç¤º â˜…
                    if (pl.isPrivate && pl.ownerUUID !== myUserId) return;

                    const label = document.createElement('label');
                    label.className = "flex items-center text-xs cursor-pointer hover:bg-indigo-900 p-1 rounded";
                    const icon = pl.isPrivate ? 'ğŸ”’ ' : '';
                    label.innerHTML = `
                        <input type="checkbox" value="${pl.id}" onchange="saveRoomSettings()" class="mr-2 w-3 h-3 accent-pink-500">
                        <span>${icon}${pl.name}</span>
                    `;
                    container.appendChild(label);
                });
            } catch (e) {
                console.error("Playlist load error:", e);
            }
        }

        // è¨­å®šã‚’ä¿å­˜
        async function saveRoomSettings() {
            if (!isHost()) return;

            const playlistCheckboxes = document.querySelectorAll('#playlistCheckboxes input[type="checkbox"]:checked');
            const playlistIds = Array.from(playlistCheckboxes).map(cb => cb.value);

            if (playlistIds.length === 0) {
                showToast("ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’æœ€ä½1ã¤é¸æŠã—ã¦ãã ã•ã„", "error");
                document.querySelector('#playlistCheckboxes input[value="global"]').checked = true;
                return;
            }

            const newSettings = {
                maxQuestions: parseInt(document.getElementById('settingMaxQuestions').value),
                correctPoints: parseInt(document.getElementById('settingCorrectPoints').value),
                wrongPoints: parseInt(document.getElementById('settingWrongPoints').value),
                playDuration: parseInt(document.getElementById('settingPlayDuration').value),
                answerTime: parseInt(document.getElementById('settingAnswerTime').value),
                handicapMode: document.getElementById('settingHandicapMode').checked,
                handicapBonus: parseInt(document.getElementById('settingHandicapBonus').value),
                handicapPenalty: parseInt(document.getElementById('settingHandicapPenalty').value),
                handicapDelay: parseFloat(document.getElementById('settingHandicapDelay').value),
                playlistIds: playlistIds
            };

            try {
                await window.VibeQuiz.updateRoomSettings(roomId, newSettings);
                console.log("Settings saved:", newSettings);
            } catch (e) {
                console.error("Settings save error:", e);
                showToast("è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼", "error");
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®ãƒ­ãƒ¼ãƒ‰ï¼ˆåˆæœŸåŒ–æ™‚ã«å‘¼ã³å‡ºã—ï¼‰
        loadPlaylistOptions();

        init();
    </script>
</body>

</html>